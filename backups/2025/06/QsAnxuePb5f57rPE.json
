{
  "active": false,
  "connections": {
    "Digitando...": {
      "main": [
        [
          {
            "node": "Resposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Saída": {
      "main": [
        [
          {
            "node": "Digitando...",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Início": {
      "main": [
        [
          {
            "node": "Filtro de Usuário",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Thread": {
      "main": [
        [
          {
            "node": "Assistente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Thread Usado": {
      "main": [
        [
          {
            "node": "Hora Interação",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Vincular Thread",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vincular Thread": {
      "main": [
        [
          {
            "node": "Filtro de Saída",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtro de Saída": {
      "main": [
        [
          {
            "node": "Saída",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Hora Interação": {
      "main": [
        [
          {
            "node": "Filtro de Saída",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gatilho Diário": {
      "main": [
        [
          {
            "node": "Expirar Thread (20 Dias)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Audio": {
      "main": [
        [
          {
            "node": "Transcrever Áudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deletar Filas": {
      "main": [
        [
          {
            "node": "Deletar Threads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Juntar Fila": {
      "main": [
        [
          {
            "node": "Limpar Fila",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpar Fila": {
      "main": [
        [
          {
            "node": "Verificar Thread",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enfileirar Msgs": {
      "main": [
        [
          {
            "node": "Verificar Msgs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Msgs": {
      "main": [
        [
          {
            "node": "Contar Msgs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recuperar Msgs": {
      "main": [
        [
          {
            "node": "Juntar Fila",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Contar Msgs": {
      "main": [
        [
          {
            "node": "20 Segundos Digitando",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capturar Áudio": {
      "main": [
        [
          {
            "node": "Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtro de Usuário": {
      "main": [
        [
          {
            "node": "Detector de Mídia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ativação Manual": {
      "main": [
        [
          {
            "node": "Deletar Filas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem": {
      "main": [
        [
          {
            "node": "Descrever Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detector de Mídia": {
      "main": [
        [
          {
            "node": "Filtro de Entrada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Capturar Áudio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tipo de Doc",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Capturar Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtro de Entrada": {
      "main": [
        [
          {
            "node": "Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Áudio -> Texto": {
      "main": [
        [
          {
            "node": "Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Imagem -> Texto": {
      "main": [
        [
          {
            "node": "Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "20 Segundos Digitando": {
      "main": [
        [
          {
            "node": "Recuperar Msgs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assistente": {
      "main": [
        [
          {
            "node": "Verificar Thread Usado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Assistente (Erro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Entrada": {
      "main": [
        [
          {
            "node": "Enfileirar Msgs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capturar Imagem": {
      "main": [
        [
          {
            "node": "Imagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capturar PDF": {
      "main": [
        [
          {
            "node": "PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF": {
      "main": [
        [
          {
            "node": "Transcrever PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcrever PDF": {
      "main": [
        [
          {
            "node": "PDF -> Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcrever Áudio": {
      "main": [
        [
          {
            "node": "Áudio -> Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF -> Texto": {
      "main": [
        [
          {
            "node": "Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capturar DOCX": {
      "main": [
        [
          {
            "node": "DOCX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DOCX -> Texto": {
      "main": [
        [
          {
            "node": "Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capturar XLSX": {
      "main": [
        [
          {
            "node": "XLSX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "XLSX": {
      "main": [
        [
          {
            "node": "Transcrever XLSX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcrever XLSX": {
      "main": [
        [
          {
            "node": "Formatar XLSX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "XLSX -> Texto": {
      "main": [
        [
          {
            "node": "Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deletar Thread (Erro)": {
      "main": [
        [
          {
            "node": "Vinc. Thread (Erro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filtro de Saída (Erro)": {
      "main": [
        [
          {
            "node": "Saída (Erro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Saída (Erro)": {
      "main": [
        [
          {
            "node": "Digitando... (Erro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Digitando... (Erro)": {
      "main": [
        [
          {
            "node": "Resposta (Erro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vinc. Thread (Erro)": {
      "main": [
        [
          {
            "node": "Filtro de Saída (Erro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Assistente (Erro)": {
      "main": [
        [
          {
            "node": "Deletar Thread (Erro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descrever Imagem": {
      "main": [
        [
          {
            "node": "Imagem -> Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tipo de Doc": {
      "main": [
        [
          {
            "node": "Capturar PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Capturar DOCX",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Capturar XLSX",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar XLSX": {
      "main": [
        [
          {
            "node": "XLSX -> Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-11T07:49:12.973Z",
  "id": "QsAnxuePb5f57rPE",
  "isArchived": false,
  "meta": null,
  "name": "My workflow 23",
  "nodes": [
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "send-presence",
        "instanceName": "TESTES",
        "remoteJid": "={{ $('Juntar Fila').item.json.whatsapp }}",
        "delay": 2000
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        3640,
        1020
      ],
      "id": "e04f31fe-f963-4eb3-862b-f3d70efcfc29",
      "name": "Digitando..."
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "TESTES",
        "remoteJid": "={{ $('Juntar Fila').item.json.whatsapp }}",
        "messageText": "={{ $('Saída').item.json.resposta.replace(/\\*\\*/g, '*') }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        3800,
        1020
      ],
      "id": "c65f9bd7-1042-417a-a6c2-7556d6435331",
      "name": "Resposta"
    },
    {
      "parameters": {
        "fieldToSplitOut": "resposta",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        3480,
        1020
      ],
      "id": "f3cdb552-4b3d-4384-90c3-e7c38beb2843",
      "name": "Saída"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "testes/messages-upsert",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1060,
        840
      ],
      "id": "4434e212-5b2d-4845-aa90-b93993132031",
      "name": "Início",
      "webhookId": "7c9e6bae-af88-4741-aa66-150a2e7bb465"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COALESCE(\n  (SELECT thread_id FROM threads WHERE whatsapp = '{{ $('Juntar Fila').item.json.whatsapp }}'),\n  ''\n) AS thread_id;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2380,
        1020
      ],
      "id": "f9db654c-2326-4713-8262-b61b76cb8c3b",
      "name": "Verificar Thread",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2cc0722d-b223-4913-9fff-f76f1c7390a7",
              "leftValue": "={{ $json.threadId }}",
              "rightValue": "={{ $('Verificar Thread').item.json.thread_id }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2960,
        1020
      ],
      "id": "69fa998e-8b27-4b5f-aad5-efa9e5319fa1",
      "name": "Verificar Thread Usado",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO threads (whatsapp, thread_id)\nVALUES ('{{ $('Juntar Fila').item.json.whatsapp }}', '{{ $('Assistente').item.json.threadId }}');\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3140,
        1120
      ],
      "id": "48eb6300-a904-40ec-bbb3-40327f0500a2",
      "name": "Vincular Thread"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "883a9619-5a61-4da8-963e-a31ec7c861d8",
              "name": "resposta",
              "value": "={{ $('Assistente').item.json.output }}",
              "type": "string"
            },
            {
              "id": "59d1addd-e715-46cf-ab99-30706ea70f05",
              "name": "threadId",
              "value": "={{ $('Assistente').item.json.threadId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3320,
        1020
      ],
      "id": "d2d0e8b6-b1c1-47d1-9c61-dbbbd5c9602d",
      "name": "Filtro de Saída"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE threads\nSET ultima_interacao = NOW()\nWHERE whatsapp = '{{ $('Juntar Fila').item.json.whatsapp }}';\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3140,
        920
      ],
      "id": "67c2c222-1edb-4165-97da-80b20a3565c0",
      "name": "Hora Interação"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -1480,
        840
      ],
      "id": "7c395313-62ed-41bb-87f5-5940dd71f223",
      "name": "Gatilho Diário"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "body.data.message.base64",
        "binaryPropertyName": "audio",
        "options": {
          "fileName": "audio.ogg"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        420,
        720
      ],
      "id": "565fe27c-898a-48a0-9cc5-7cacd44a072c",
      "name": "Audio"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM mensagens_temp\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1040,
        1160
      ],
      "id": "073fb281-b95b-49cf-a35e-2b87ce322428",
      "name": "Deletar Filas"
    },
    {
      "parameters": {
        "jsCode": "// Junta todas as mensagens com quebra de linha\nconst mensagens = items.map(item => item.json.mensagem);\nconst textoUnico = mensagens.join('\\n\\n');\n\n// Tenta buscar do Filtro de Entrada\nlet whatsapp = '';\nlet nome = '';\n\n  whatsapp = $input.first().json.whatsapp;\n  nome = $input.first().json.nome;\n\nreturn [{\n  json: {\n    whatsapp,\n    nome,\n    mensagem: textoUnico\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2060,
        1020
      ],
      "id": "c2c14ac1-03c3-447e-bb2b-82abd991ddc7",
      "name": "Juntar Fila"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM mensagens_temp\n WHERE whatsapp = '{{ $('Juntar Fila').item.json.whatsapp }}'\n   AND status = 'aguardando';\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2220,
        1020
      ],
      "id": "25c046c9-a06f-4f72-b922-e26453805328",
      "name": "Limpar Fila"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO mensagens_temp (whatsapp, nome, mensagem, status)\nVALUES ($1, $2, $3, $4);\n",
        "options": {
          "queryReplacement": "={{ [ $json.whatsapp, $json.nome, $json.mensagem, 'aguardando' ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1200,
        1020
      ],
      "id": "1302d2b8-1e9d-4e87-80f2-f68d318a528a",
      "name": "Enfileirar Msgs"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) AS cnt\n  FROM mensagens_temp\n WHERE whatsapp = '{{ $('Entrada').item.json.whatsapp }}'\n   AND status = 'aguardando';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1360,
        1020
      ],
      "id": "f1a14bb3-bd1d-4a3f-97c1-d4c09ce61612",
      "name": "Verificar Msgs"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT whatsapp, nome, mensagem\n  FROM mensagens_temp\n WHERE whatsapp = '{{ $('Entrada').item.json.whatsapp }}'\n   AND status = 'aguardando'\n ORDER BY data ASC;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1900,
        1020
      ],
      "id": "c227c968-5e4b-4bdb-9980-53fc4512a3a1",
      "name": "Recuperar Msgs"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a4625778-dc64-4bbb-948e-d96c81dc1a18",
              "leftValue": "={{ $json.cnt }}",
              "rightValue": "=1",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1520,
        1020
      ],
      "id": "2d739388-1ec5-4213-a561-3c73b3bcfcf7",
      "name": "Contar Msgs"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ac010987-c4ca-4f8a-b8ec-d48ccd0cfa21",
              "name": "body.data.message.base64",
              "value": "={{ $('Início').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        260,
        720
      ],
      "id": "6d9699c6-d5e8-4ace-a134-74a8e8acad99",
      "name": "Capturar Áudio"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d264c6f7-86a4-4169-869a-9bdabd7435af",
              "leftValue": "={{ $json.body.data.key.fromMe }}",
              "rightValue": "false",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "c6359808-8b23-484e-830f-9c1b919030e6",
              "leftValue": "={{ $json.body.data.key.remoteJid.split(\"@\") [0] }}",
              "rightValue": "55149900000000",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -900,
        840
      ],
      "id": "839d2803-ab04-44e0-a002-cf9e7ffe7c07",
      "name": "Filtro de Usuário",
      "notesInFlow": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -1200,
        1160
      ],
      "id": "5dfe8368-4a01-46f2-b0a8-c56604ae19a9",
      "name": "Ativação Manual"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "body.data.message.base64",
        "binaryPropertyName": "=imagem",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        420,
        1520
      ],
      "id": "5767af5d-3408-4588-9668-10987edf354b",
      "name": "Imagem"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "63ce0d97-945b-487b-a3bd-ad49efe04560",
                    "leftValue": "={{ $json.body.data.message.conversation }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Início').item.json.body.data.message.audioMessage }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "d650347e-dca4-43c2-ba06-74cecb71d271"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b23a3584-07d1-413e-9629-c181763e5009",
                    "leftValue": "={{ $json.body.data.message.documentMessage }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "20f4c0e9-3723-417c-b82b-508b49d63cfd",
                    "leftValue": "={{ $json.body.data.message.imageMessage }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -620,
        820
      ],
      "id": "b554e318-78ed-472a-96c0-04ec315266da",
      "name": "Detector de Mídia",
      "notesInFlow": true,
      "notes": "Áudio - Documento - Imagem"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8474886a-8a48-4ea3-b6c6-5991c31ad43a",
              "name": "whatsapp",
              "value": "={{ $('Início').item.json.body.data.key.remoteJid.split(\"@\") [0] }}",
              "type": "string"
            },
            {
              "id": "5d3e2384-0685-49f3-8f35-d32a2a483d92",
              "name": "nome",
              "value": "={{ $('Início').item.json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "a0e341a7-dabb-4b51-9b6b-7d910c29a484",
              "name": "mensagem",
              "value": "={{ $('Início').item.json.body.data.message.conversation }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        740,
        520
      ],
      "id": "b82041d5-7551-4da9-a3c4-9246e8c35b72",
      "name": "Filtro de Entrada"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8474886a-8a48-4ea3-b6c6-5991c31ad43a",
              "name": "whatsapp",
              "value": "={{ $('Início').item.json.body.data.key.remoteJid.split(\"@\") [0]  }}",
              "type": "string"
            },
            {
              "id": "5d3e2384-0685-49f3-8f35-d32a2a483d92",
              "name": "nome",
              "value": "={{ $('Início').item.json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "a0e341a7-dabb-4b51-9b6b-7d910c29a484",
              "name": "mensagem",
              "value": "=**SISTEMA:** Mensagem de Áudio com o possível conteúdo:\n\n{{ $json.text }}",
              "type": "string"
            },
            {
              "id": "8c81054d-8f09-45da-9a99-0c5ddff89c32",
              "name": "id",
              "value": "={{ $json.id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        740,
        720
      ],
      "id": "c1f31eff-4559-44be-a8f8-fd9e06769dad",
      "name": "Áudio -> Texto"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8474886a-8a48-4ea3-b6c6-5991c31ad43a",
              "name": "whatsapp",
              "value": "={{ $('Início').item.json.body.data.key.remoteJid.split(\"@\") [0] }}",
              "type": "string"
            },
            {
              "id": "5d3e2384-0685-49f3-8f35-d32a2a483d92",
              "name": "nome",
              "value": "={{ $('Início').item.json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "a0e341a7-dabb-4b51-9b6b-7d910c29a484",
              "name": "mensagem",
              "value": "={{ $('Início').item.json.body.data.message.imageMessage.caption }}\n\n**SISTEMA:** Anexo de Imagem analisado:\n\n{{ $json.output.descricao_arquivo || 'Não foi possível analisar.'}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        740,
        1520
      ],
      "id": "e9e74332-6513-4cfd-977d-204512a60416",
      "name": "Imagem -> Texto"
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "send-presence",
        "instanceName": "TESTES",
        "remoteJid": "={{ $('Entrada').item.json.whatsapp }}",
        "delay": 20000
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        1740,
        1020
      ],
      "id": "6a02972b-f3fc-46b6-9525-3dd51f410e16",
      "name": "20 Segundos Digitando"
    },
    {
      "parameters": {
        "resource": "assistant",
        "assistantId": {
          "__rl": true,
          "value": "asst_6Am7ljxKsroSeItcRqmk3dUI",
          "mode": "list",
          "cachedResultName": "Assistente Pessoal"
        },
        "prompt": "define",
        "text": "=- **Hora e Data atual:** {{ DateTime.fromISO($now).toFormat(\"HH:mm:ss | dd/MM/yyyy | cccc\", { locale: \"pt-BR\" }) }}\n- **Nome do Usuário:** {{ $('Juntar Fila').item.json.nome }}\n- **WhatsApp:** {{ $('Juntar Fila').item.json.whatsapp }}\n\n{{ $('Juntar Fila').item.json.mensagem }}",
        "memory": "threadId",
        "threadId": "={{ $json.thread_id }}",
        "options": {
          "preserveOriginalTools": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2540,
        1020
      ],
      "id": "de032b6f-1c02-4327-890a-4efeeb1d6a69",
      "name": "Assistente",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8474886a-8a48-4ea3-b6c6-5991c31ad43a",
              "name": "whatsapp",
              "value": "={{ $json.whatsapp }}",
              "type": "string"
            },
            {
              "id": "5d3e2384-0685-49f3-8f35-d32a2a483d92",
              "name": "nome",
              "value": "={{ $json.nome }}",
              "type": "string"
            },
            {
              "id": "a0e341a7-dabb-4b51-9b6b-7d910c29a484",
              "name": "mensagem",
              "value": "={{ $json.mensagem }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1040,
        1020
      ],
      "id": "a51459fe-8fe5-4b45-a345-5aab225e9dfe",
      "name": "Entrada"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM threads\nWHERE ultima_interacao < NOW() - INTERVAL '20 days';\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1320,
        840
      ],
      "id": "8999e1e3-ad0c-4e39-982c-845907cdbd70",
      "name": "Expirar Thread (20 Dias)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0a3355ba-e110-4111-95cb-e8d8fa888a6d",
              "name": "body.data.message.base64",
              "value": "={{ $('Filtro de Usuário').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        260,
        1520
      ],
      "id": "c947eebb-4159-40cb-a7a7-e42088a313bc",
      "name": "Capturar Imagem"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0a3355ba-e110-4111-95cb-e8d8fa888a6d",
              "name": "body.data.message.base64",
              "value": "={{ $('Filtro de Usuário').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        260,
        920
      ],
      "id": "beecadf3-f341-4dcb-891f-5d68a434c611",
      "name": "Capturar PDF"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "body.data.message.base64",
        "binaryPropertyName": "=documento",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        420,
        920
      ],
      "id": "e4bf4532-a922-4dca-bad7-f80298f37bea",
      "name": "PDF"
    },
    {
      "parameters": {
        "operation": "pdf",
        "binaryPropertyName": "documento",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        580,
        920
      ],
      "id": "16bdd45e-ebb9-4777-bb9e-7132fa35c412",
      "name": "Transcrever PDF"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "binaryPropertyName": "audio",
        "options": {
          "language": "pt"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        580,
        720
      ],
      "id": "c9be46e9-22cd-457f-aee4-73dd81eeaeff",
      "name": "Transcrever Áudio"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8474886a-8a48-4ea3-b6c6-5991c31ad43a",
              "name": "whatsapp",
              "value": "={{ $('Início').item.json.body.data.key.remoteJid.split(\"@\") [0] }}",
              "type": "string"
            },
            {
              "id": "5d3e2384-0685-49f3-8f35-d32a2a483d92",
              "name": "nome",
              "value": "={{ $('Início').item.json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "a0e341a7-dabb-4b51-9b6b-7d910c29a484",
              "name": "mensagem",
              "value": "={{ $('Início').item.json.body.data.message.documentMessage.caption }}\n\n**SISTEMA:** Anexo PDF analisado:\n\n{{ $json.text || 'Não foi possível analisar.'}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        740,
        920
      ],
      "id": "8884722b-7d66-4c32-9e44-26db37018a59",
      "name": "PDF -> Texto"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM threads\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -880,
        1160
      ],
      "id": "9bc54181-ba1c-4388-8358-360e1c40de8c",
      "name": "Deletar Threads"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0a3355ba-e110-4111-95cb-e8d8fa888a6d",
              "name": "body.data.message.base64",
              "value": "={{ $('Filtro de Usuário').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        260,
        1120
      ],
      "id": "5b118869-124c-45c5-baf5-8bd2d25362a2",
      "name": "Capturar DOCX"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "body.data.message.base64",
        "binaryPropertyName": "=documento",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        420,
        1120
      ],
      "id": "66efc8c3-a8c6-47ee-ac12-7ce37b8f40d7",
      "name": "DOCX"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8474886a-8a48-4ea3-b6c6-5991c31ad43a",
              "name": "whatsapp",
              "value": "={{ $('Início').item.json.body.data.key.remoteJid.split(\"@\") [0] }}",
              "type": "string"
            },
            {
              "id": "5d3e2384-0685-49f3-8f35-d32a2a483d92",
              "name": "nome",
              "value": "={{ $('Início').item.json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "a0e341a7-dabb-4b51-9b6b-7d910c29a484",
              "name": "mensagem",
              "value": "={{ $('Início').item.json.body.data.message.documentMessage.caption }}\n\n**SISTEMA:** Anexo DOCX analisado:\n\n{{ $json.text || 'Não foi possível analisar.'}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        740,
        1120
      ],
      "id": "7769ff6e-125c-4220-bf56-11a39db72ec8",
      "name": "DOCX -> Texto"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "0a3355ba-e110-4111-95cb-e8d8fa888a6d",
              "name": "body.data.message.base64",
              "value": "={{ $('Filtro de Usuário').item.json.body.data.message.base64 }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        100,
        1320
      ],
      "id": "87208a5c-64f8-4543-97d2-ccbbd62742b6",
      "name": "Capturar XLSX"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "body.data.message.base64",
        "binaryPropertyName": "=documento",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        260,
        1320
      ],
      "id": "329d5d21-fa6d-460a-8849-15892d5a222a",
      "name": "XLSX"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "binaryPropertyName": "documento",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        420,
        1320
      ],
      "id": "97ecc09c-e4ef-4b35-8701-6b736b8dfe2c",
      "name": "Transcrever XLSX"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8474886a-8a48-4ea3-b6c6-5991c31ad43a",
              "name": "whatsapp",
              "value": "={{ $('Início').first().json.body.data.key.remoteJid.split(\"@\")[0] }}",
              "type": "string"
            },
            {
              "id": "5d3e2384-0685-49f3-8f35-d32a2a483d92",
              "name": "nome",
              "value": "={{ $('Início').first().json.body.data.pushName }}",
              "type": "string"
            },
            {
              "id": "a0e341a7-dabb-4b51-9b6b-7d910c29a484",
              "name": "mensagem",
              "value": "={{ $('Início').first().json.body.data.message.documentMessage.caption }}\n\n**SISTEMA:** Anexo XLSX analisado:\n\n{{ JSON.stringify($json.todos_os_dados, null, 2) || 'Não foi possível analisar.'}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        740,
        1320
      ],
      "id": "4688425d-cff9-4d2e-999d-186f91136202",
      "name": "XLSX -> Texto"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-docx-converter.docxToText",
      "typeVersion": 1,
      "position": [
        580,
        1120
      ],
      "id": "13138908-48b7-4fde-904a-5e1c233df12d",
      "name": "Transcrever DOCX"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM threads WHERE whatsapp = '{{ $('Juntar Fila').item.json.whatsapp }}';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3540,
        540
      ],
      "id": "711b7b5f-0757-4bfa-8d15-eb6d79377623",
      "name": "Deletar Thread (Erro)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "883a9619-5a61-4da8-963e-a31ec7c861d8",
              "name": "resposta",
              "value": "={{ $('Assistente').item.json.output.replace(/\\*\\*/g, '*') }}",
              "type": "string"
            },
            {
              "id": "59d1addd-e715-46cf-ab99-30706ea70f05",
              "name": "threadId",
              "value": "={{ $('Assistente').item.json.threadId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3860,
        540
      ],
      "id": "1c8d706e-2b6e-41f8-8132-a2c4c48cafaf",
      "name": "Filtro de Saída (Erro)"
    },
    {
      "parameters": {
        "fieldToSplitOut": "resposta",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        4020,
        540
      ],
      "id": "108ab00e-7f42-4e21-8851-43491feae583",
      "name": "Saída (Erro)"
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "send-presence",
        "instanceName": "TESTES",
        "remoteJid": "={{ $('Juntar Fila').item.json.whatsapp }}",
        "delay": 2000
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        4180,
        540
      ],
      "id": "daa278fd-456a-4118-8ce8-54873ee6b3f5",
      "name": "Digitando... (Erro)"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "TESTES",
        "remoteJid": "={{ $('Juntar Fila').item.json.whatsapp }}",
        "messageText": "={{ $('Assistente (Erro)').item.json.output }}",
        "options_message": {}
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        4340,
        540
      ],
      "id": "960c672d-a3dd-4e60-8e43-83acdb56d934",
      "name": "Resposta (Erro)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO threads (whatsapp, thread_id)\nVALUES ('{{ $('Juntar Fila').item.json.whatsapp }}', '{{ $('Assistente (Erro)').item.json.threadId }}');\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3700,
        540
      ],
      "id": "b892d718-0b32-4099-896b-b39fbdabe7d8",
      "name": "Vinc. Thread (Erro)"
    },
    {
      "parameters": {
        "resource": "assistant",
        "assistantId": {
          "__rl": true,
          "value": "asst_6Am7ljxKsroSeItcRqmk3dUI",
          "mode": "list",
          "cachedResultName": "Assistente Pessoal"
        },
        "prompt": "define",
        "text": "=- **Hora e Data atual:** {{ DateTime.fromISO($now).toFormat(\"HH:mm:ss | dd/MM/yyyy | cccc\", { locale: \"pt-BR\" }) }}\n- **Nome do Cliente:** {{ $('Juntar Fila').item.json.nome }}\n- **WhatsApp:** {{ $('Juntar Fila').item.json.whatsapp }}\n\n**SISTEMA:** Problema Técnico identificado. Informe o usuário do problema e diga que vai iniciar uma nova memória. Dito isso, pergunte o que ele precisava de uma forma criativa.\n\n**Última mensagem do usuário antes do erro:**\n\n{{ $('Juntar Fila').item.json.mensagem }}",
        "memory": "threadId",
        "threadId": "=",
        "options": {
          "preserveOriginalTools": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        3140,
        540
      ],
      "id": "c168aa34-add9-4728-8cbc-61c4ce15e9da",
      "name": "Assistente (Erro)",
      "retryOnFail": true,
      "waitBetweenTries": 2000,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "id"
        },
        "text": "Descreva esta imagem com o máximo de detalhes possíveis",
        "inputType": "base64",
        "binaryPropertyName": "imagem",
        "options": {
          "detail": "high",
          "maxTokens": 32768
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        580,
        1520
      ],
      "id": "be6b6c5a-aeed-4744-95f0-fd9127b60e9c",
      "name": "Descrever Imagem"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.data.message.documentMessage.title }}",
                    "rightValue": "pdf",
                    "operator": {
                      "type": "string",
                      "operation": "endsWith"
                    },
                    "id": "f89dc4a8-d13f-487c-91c4-efbbf7946385"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "49cb11d1-5d59-4e1b-8ef6-e54c5f1d0d66",
                    "leftValue": "={{ $json.body.data.message.documentMessage.title }}",
                    "rightValue": "docx",
                    "operator": {
                      "type": "string",
                      "operation": "endsWith"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "381e924b-1628-44bd-b759-d672c2ad8cbc",
                    "leftValue": "={{ $json.body.data.message.documentMessage.title }}",
                    "rightValue": "xlsx",
                    "operator": {
                      "type": "string",
                      "operation": "endsWith"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -120,
        1020
      ],
      "id": "7180add2-334a-4376-8934-13d7dae6b1a3",
      "name": "Tipo de Doc"
    },
    {
      "parameters": {
        "jsCode": "return [\n  {\n    json: {\n      todos_os_dados: items.map(item => item.json)\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        580,
        1320
      ],
      "id": "b2356d46-cc30-4790-9ba2-e2e2f96da0b5",
      "name": "Formatar XLSX"
    },
    {
      "parameters": {
        "content": "# Fluxo de erro:\n\n- Avisa o usuário da falha\n- Cria novo thread\n- Vincula novo thread ao whatsapp do usuário",
        "height": 380,
        "width": 1420,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3120,
        360
      ],
      "typeVersion": 1,
      "id": "06cf95c2-49fc-4769-98cd-1d6afd4ac778",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "# Empilha mensagens para enviar todas para o Assistente de IA\n\nAcredito que da pra fazer bem melhor pois ele conta 20 segundos apenas a partir da primeira mensagem e empilha o resto durante esse tempo. Deveria ser uns 15 segundos a partir de cada mensagem. As vezes até menos tempo...",
        "height": 320,
        "width": 1160
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1180,
        880
      ],
      "typeVersion": 1,
      "id": "93f84d0d-24ac-4f51-be10-e3879ec2f295",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "Resgata o Thread vinculado ao número do usuário para manter o contexto da conversa (memória)",
        "height": 240,
        "width": 480,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2360,
        960
      ],
      "typeVersion": 1,
      "id": "776861bb-a5ed-4e17-9516-d8cf08970646",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "# Filtros de Mídia\n\nPara separar mensagens com anexo de PDF, DOCX, XLSX, Imagem (.jpg) ou Áudio de WhatsApp (.opus)",
        "height": 1220,
        "width": 1820,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -660,
        480
      ],
      "typeVersion": 1,
      "id": "003e0350-9c17-41d3-8891-04de62cee671",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## Entrada e Filtro de Usuário\n\nIdentifica se a mensagem vem do próprio número e de um número específico.\n\n- Se sim, continua o fluxo.\n- Se não, para o fluxo.\n\n---\n\n*a parte do número específico pode ser removido conforme necessidade*",
        "height": 440,
        "width": 420
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1100,
        560
      ],
      "typeVersion": 1,
      "id": "4f7d17fb-0879-4784-a8c4-c4d5e59e5e1b",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Saída\n\nEnvia a presença \"Digitando\" durante 2 segundos e depois envia a resposta do Assistente para o usuário via Evolution API",
        "height": 320,
        "width": 380,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3620,
        880
      ],
      "typeVersion": 1,
      "id": "f6e7de5a-eb6c-48db-8e05-506142e9b549",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## Memória\n\n- Se o Thread não existir no Banco, vincula novo Thread da OpenAI ao número do WhatsApp do usuário.\n\n- Se o Thread já existe no Banco, atualiza a hora da última interação no Banco.",
        "height": 540,
        "width": 740,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2860,
        760
      ],
      "typeVersion": 1,
      "id": "01730a98-8e5e-4a28-a4a4-88f03eba2cf9",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "# Nodes da Comunidade Necessários\n\n- n8n-nodes-docx-converter\n- n8n-nodes-evolution-api\n\n*Os nodes acima não estão disponíveis de forma nativa no n8n e precisam ser instalados antes de executar o workflow*",
        "height": 220,
        "width": 640,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        240
      ],
      "typeVersion": 1,
      "id": "3870b159-1439-4f3c-b172-1a4b4e2c14c1",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Cria as tabelas necessárias para o funcionamento do bot\n-- Antes, não se esqueça de criar o banco de dados com o nome de sua preferência e configurar as credenciais\n\nCREATE TABLE mensagens_temp(\n    whatsapp text,\n    mensagem text,\n    \"data\" timestamp without time zone DEFAULT now(),\n    status text,\n    nome text\n);\n\nCREATE TABLE threads(\n    whatsapp text,\n    thread_id text,\n    ultima_interacao timestamp without time zone DEFAULT now()\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1660,
        1200
      ],
      "id": "76b38a5b-2e05-4ad9-8f32-1d77671174b9",
      "name": "Criar Tabelas"
    },
    {
      "parameters": {
        "content": "## Cria Tabelas Necessárias\n\nNão se esqueça de criar uma nova database antes de criar as tabelas. O node abaixo, ao executado, cria todas as tabelas necessárias para as operações de todo o Workflow. Execute apenas uma vez depois de ja ter criado a database.",
        "height": 340,
        "width": 420
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1680,
        1020
      ],
      "typeVersion": 1,
      "id": "1c9b1b86-b966-45d9-b241-7a5b9d774327",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## Limpa Tabelas\n\nQuando executados, limpa todas as tabelas de threads vinculados a números de WhatsApp e mensagens presas na fila. Usei com frequência durante os testes e pode ser bem útil.",
        "height": 300,
        "width": 560
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1240,
        1020
      ],
      "typeVersion": 1,
      "id": "f08adb17-efc7-44a9-85b6-e8e6055f0e09",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "## Desvincula Threads\n\nGatilho diário que deleta do Banco Threads vinculados sem interação do usuário por mais de 20 dias. Útil para manter certa organização e fazer uma limpeza a fim de economizar tokens com conversas desnecessariamente longas.",
        "height": 340,
        "width": 400
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1520,
        660
      ],
      "typeVersion": 1,
      "id": "5e2e8ee9-0f6e-4396-b057-eaef6fe77438",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "content": "# Credenciais Necessárias\n\n- **OpenAI API Key para os nodes da OpenAI**\n    - Necessário ter um assistente configurado no painel: https://platform.openai.com/assistants\n\n- **Postgres (Host, Usuário, Senha e Database)**\n    - Os Threads da OpenAI são vinculados aos números de WhatsApp dos usuários para manter a memória/contexto da conversa. Acredito que seja mais eficiente e barato do que usar o conector de memória do n8n.\n    - Também serve para enfileirar as mensagens enviadas pelo usuário dentro de um prazo de 20 segundos em que é enviado um sinal de \"Digitando\" para serem empilhadas e enviadas de uma só vez para a IA. Ajuda a evitar que ela envie uma mensagem para cada mensagem individual do usuário em um curto período.",
        "height": 360,
        "width": 640,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -660,
        100
      ],
      "typeVersion": 1,
      "id": "cee09dc3-dd0f-4bb8-9a4a-711fe57b78b6",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "content": "## Caso tenha alguma dúvida ou sugestão de melhoria, sinta-se livre para me chamar via LinkedIn: https://linkedin.com/in/ferreirajgb",
        "height": 220,
        "width": 640,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        0
      ],
      "typeVersion": 1,
      "id": "75e73125-6819-4f3b-bc6b-03c6b3ff5890",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "content": "## As operações feitas com Banco de Dados são apenas para empilhar mensagens antes de juntar e para vincular um Thread a um número de WhatsApp para permitir que o Assistente use o numero do usuáio como verificador para buscar o contexto/memória da conversa",
        "height": 260,
        "width": 640,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1180,
        600
      ],
      "typeVersion": 1,
      "id": "a6a5a4ce-0fbe-446e-ba14-ac23ac8e08c5",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "content": "# Resumo Geral\n(escrito com IA - GPT o3)\n\n## 1. Entrada e primeiros filtros\n\n1. **Webhook `Início`** (`/testes/messages-upsert`) recebe TODAS as mensagens que o Evolution envia.\n2. **`Filtro de Usuário`** garante que:\n\n   * a mensagem não foi enviada por você mesmo (`fromMe = false`);\n   * opcionalmente vem de um número específico (`remoteJid.split('@')[0] == 55149900000000`).\n3. **`Detector de Mídia`** (switch) descobre o tipo de conteúdo e envia para o ramo correto:\n\n   * Texto simples → vai direto para **`Filtro de Entrada`**.\n   * Áudio → captura base64, converte em arquivo, transcreve com Whisper e gera mensagem “**SISTEMA:** Mensagem de Áudio …”.\n   * Imagem → converte em arquivo, pede para o GPT-4-Vision descrever, concatena legenda + descrição.\n   * Documentos (`pdf | docx | xlsx`) → converte, extrai texto/dados e coloca na mensagem “**SISTEMA:** Anexo <tipo> analisado…”.\n\nTodas essas ramificações terminam gerando **três campos limpinhos** (`whatsapp`, `nome`, `mensagem`) que o node **`Entrada`** deixa prontos para a próxima fase.\n\n---\n\n## 2. Fila de mensagens (anti-flood)\n\n1. **`Enfileirar Msgs`** grava cada entrada em `mensagens_temp` com status `aguardando`.\n2. **`Verificar Msgs → Contar Msgs`**\n\n   * Se for a **primeira** mensagem na fila, o fluxo dispara **`20 Segundos Digitando`**: envia “presence typing” por 20 s e então…\n   * …busca **todas** as mensagens acumuladas no intervalo (**`Recuperar Msgs → Juntar Fila`**), junta com `\\n\\n`, limpa a fila (`Limpar Fila`) e segue.\n\n> 💡 *Comentário da sticky note*: hoje o timer é fixo (20 s a partir da 1ª mensagem). Você pode trocá-lo por um `Wait` + `Reset Timer` a cada nova mensagem para ter “15 s desde a última”.\n\n---\n\n## 3. Memória: vínculo WhatsApp ↔ Thread OpenAI\n\n1. **`Verificar Thread`** consulta tabela `threads` para descobrir se já existe `thread_id` para aquele número.\n2. **`Assistente`** (node LangChain/OpenAI) envia:\n\n   * “cabecalho” com hora, usuário, etc.\n   * o **texto concatenado** das mensagens.\n   * `threadId` (se achou).\n3. **`Verificar Thread Usado`** compara o `threadId` que voltou do Assistente com o que estava no banco:\n\n   * **Já existia e bateu** → só faz **`Hora Interação`** (UPDATE `ultima_interacao = NOW()`).\n   * **Não existia** ou mudou → **`Vincular Thread`** grava o novo pair (INSERT).\n\n---\n\n## 4. Saída normal\n\n1. **`Filtro de Saída`** transforma a resposta do Assistente (troca `**bold**` por `*bold*` para o WhatsApp).\n2. **`Saída`** faz split caso a IA quebre a resposta em partes.\n3. **`Digitando...`** presence 2 s → **`Resposta`** manda o texto pelo Evolution.\n\n---\n\n## 5. Fluxo de erro controlado\n\nSe o node **`Assistente`** cair em exceção:\n\n* **`Assistente (Erro)`** gera uma nova thread explicando ao usuário que houve falha e pede para repetir a intenção.\n* Apaga o vínculo antigo (**`Deletar Thread (Erro)`**) e grava o novo (**`Vinc. Thread (Erro)`**) antes de enviar “Digitando… (Erro)” e “Resposta (Erro)”.\n\n---\n\n## 6. Manutenção e utilidades\n\n| Node                                            | O que faz                                                                    |\n| ----------------------------------------------- | ---------------------------------------------------------------------------- |\n| **`Gatilho Diário → Expirar Thread (20 Dias)`** | DELETE em `threads` que não recebem interação há 20 dias (economiza tokens). |\n| **`Ativação Manual`**                           | Pipeline que limpa `mensagens_temp` e `threads` inteiras — útil nos testes.  |\n| **`Criar Tabelas`**                             | Execução única: cria `mensagens_temp` e `threads`.                           |\n\n---\n\n## 7. Dependências externas\n\n* **Evolution API nodes** – envio/recepção WhatsApp.\n* **OpenAI (LangChain)** – Assistente, Whisper, Vision.\n* **n8n-nodes-docx-converter** – extrair texto de DOCX.\n* **PostgreSQL** – armazenamento de fila e memória.\n\n---\n\n### Resumo curtinho\n\n1. **Recebe mensagem** → 2. **Detecta tipo & converte p/ texto** → 3. **Empilha por 20 s** → 4. **Envia lote p/ Assistente com memória persistida em Postgres** → 5. **Atualiza ou cria thread** → 6. **Simula “digitando” e devolve resposta** → 7. **Limpeza diária + rotinas auxiliares** → 8. **Fluxo de fallback em caso de erro**.\n",
        "height": 2040,
        "width": 1160,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2860,
        1020
      ],
      "typeVersion": 1,
      "id": "6759590f-13cb-4bb7-99b5-cfa31db43790",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "content": "# Usando Evolution API no n8n para WhatsApp\n(escrito com IA - GPT 4.1)\n\nEste rápido tutorial ajudará você a configurar o Evolution API no n8n e entender como funciona o formato dos IDs para grupos e usuários individuais no WhatsApp.\n\n## 🚀 1. Instalando Nodes do Evolution API no n8n\n\n- Abra seu painel do n8n.\n- Clique em **Settings → Community Nodes**.\n- Na caixa de busca, digite `n8n-nodes-evolution-api`.\n- Clique em **Install**. Aguarde a instalação ser concluída (pode levar alguns segundos).\n\nApós instalado, atualize a página. Você já deve ver nodes relacionados ao Evolution API ao criar um novo workflow.\n\n---\n\n## 🔑 2. Configurando Credenciais do Evolution API\n\n- No painel do Evolution API, verifique e anote:\n  - URL base (exemplo: `http://localhost:8080`)\n  - Sua Instance Key (Chave de instância/token)\n\nAgora:\n\n- No n8n, vá em **Credentials → Add Credential → Evolution API**.\n- Informe:\n  - **Base URL** (ex.: `http://localhost:8080`)\n  - **API Key** (instance key/token do Evolution).\n\nClique em **Save**.\n\n---\n\n## 📝 3. Testando o envio através do Evolution API no n8n\n\n- Em um novo workflow, adicione um node do tipo \"**Evolution API Send Message**\".\n- Nas configurações do node insira as suas credenciais criadas no passo anterior.\n- Preencha os campos obrigatórios:\n  - `Instance`: Nome da instância (a mesma configurada no Evolution API — normalmente a Instance Key).\n  - `Number`: ID do contato (veja formato abaixo).\n  - `Message`: Mensagem que será enviada.\n\n---\n\n## 📱 4. Formato dos números para envio individual e em grupo no WhatsApp (Evolution API)\n\nNo Evolution API os IDs/números do WhatsApp possuem diferentes formatos dependendo se é envio privado ou para grupos:\n\n🟢 **Mensagens privadas (contatos individuais)**:\n\n```markdown\nFormato:\n<número de telefone>@s.whatsapp.net\n\nExemplo:\n5511977771234@s.whatsapp.net\n```\n\nℹ️ **Formato detalhado**:\n- Código do país (**55** para Brasil) + DDD (sem o zero) + número\n- Final sempre: `@s.whatsapp.net`\n\n🟢 **Mensagens para grupos**:\n\n```markdown\nFormato:\n<id do grupo>@g.us\n\nExemplo:\n120363038634395676@g.us\n```\n\nEspero que seja útil! Aproveite para turbinar suas automações com WhatsApp + n8n. 🚀🔥",
        "height": 1900,
        "width": 1140,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3620,
        1220
      ],
      "typeVersion": 1,
      "id": "a42b67ba-cf61-418c-a663-ebea996e7cc9",
      "name": "Sticky Note15",
      "disabled": true
    }
  ],
  "pinData": {},
  "repo_name": "backup-n8n",
  "repo_owner": "faelsou",
  "repo_path": "backups",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-06-11T07:49:12.973Z",
      "updatedAt": "2025-06-11T07:49:12.973Z",
      "role": "workflow:owner",
      "workflowId": "QsAnxuePb5f57rPE",
      "projectId": "uxvBhUmI1Fx6jdU7"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-06-09T11:52:25.333Z",
      "updatedAt": "2025-06-09T11:52:25.333Z",
      "id": "5yPUOfn6imAe4TmU",
      "name": "WhatsApp"
    },
    {
      "createdAt": "2025-06-09T11:52:25.315Z",
      "updatedAt": "2025-06-09T11:52:25.315Z",
      "id": "YnqV5MUPsc9LJMrj",
      "name": "Inteligência Artificial"
    }
  ],
  "triggerCount": 0,
  "updatedAt": "2025-06-11T07:49:12.973Z",
  "versionId": "c50f31a4-5839-4f30-a37c-e1952db7ca82"
}