{
  "active": false,
  "connections": {
    "Middleware Auth JWT": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sessão Ativa?": {
      "main": [
        [
          {
            "node": "Merge Auth Cliente",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Response Auth Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Criar Cliente": {
      "main": [
        [
          {
            "node": "Validar Input Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Input Cliente": {
      "main": [
        [
          {
            "node": "Input Cliente Válido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Cliente Válido?": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Validation Cliente Error",
            "type": "main",
            "index": 0
          },
          {
            "node": "Response Auth Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Auth Cliente": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Sessão Ativa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Cliente Auth": {
      "main": [
        [
          {
            "node": "Response Cliente Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Middleware Auth JWT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Inserir Cliente Auth",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Login": {
      "main": [
        [
          {
            "node": "Validar Input Login",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Input Login": {
      "main": [
        [
          {
            "node": "Input Válido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Válido?": {
      "main": [
        [
          {
            "node": "Buscar Usuário",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Validation Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuário": {
      "main": [
        [
          {
            "node": "Usuário Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usuário Existe?": {
      "main": [
        [
          {
            "node": "Merge Dados Login",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Response Login Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Dados Login": {
      "main": [
        [
          {
            "node": "Validar Senha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Senha": {
      "main": [
        [
          {
            "node": "Senha Válida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Senha Válida?": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Login Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Create Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Session": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Auditoria Login1": {
      "main": [
        [
          {
            "node": "Response Login Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Log Auditoria Login1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Code gerador de UUID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code gerador de UUID": {
      "main": [
        [
          {
            "node": "Inserir Cliente Auth",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-12-22T14:02:10.759Z",
  "id": "roCzi3PseAtbr8r2",
  "isArchived": false,
  "meta": null,
  "name": "Backend-credGestor-new-PRD",
  "nodes": [
    {
      "parameters": {
        "jsCode": "function getAuthHeader(headers) {\n  if (!headers) return '';\n\n  // tenta variações comuns\n  return (\n    headers.authorization ||\n    headers.Authorization ||\n    headers.AUTHORIZATION ||\n    headers['x-authorization'] ||\n    headers['X-Authorization'] ||\n    ''\n  );\n}\n\nfunction base64UrlDecode(str) {\n  const pad = str.length % 4 === 0 ? '' : '='.repeat(4 - (str.length % 4));\n  const b64 = (str + pad).replace(/-/g, '+').replace(/_/g, '/');\n  return JSON.parse(Buffer.from(b64, 'base64').toString('utf8'));\n}\n\nconst headers = $json.headers || {};\nconst authHeader = getAuthHeader(headers);\n\nif (!authHeader || !authHeader.startsWith('Bearer ')) {\n  return [{ json: { autenticado: false, erro: 'INVALID_TOKEN_FORMAT', authHeader } }];\n}\n\nconst token = authHeader.slice(7).trim();\nconst parts = token.split('.');\n\nif (parts.length !== 3) {\n  return [{ json: { autenticado: false, erro: 'INVALID_JWT_FORMAT', token_preview: token.slice(0, 20) } }];\n}\n\nlet payload;\ntry {\n  payload = base64UrlDecode(parts[1]);\n} catch (e) {\n  return [{ json: { autenticado: false, erro: 'INVALID_JWT_PAYLOAD' } }];\n}\n\nif (payload.exp && payload.exp * 1000 < Date.now()) {\n  return [{ json: { autenticado: false, erro: 'TOKEN_EXPIRED' } }];\n}\n\nif (!payload.tenant_id) {\n  return [{ json: { autenticado: false, erro: 'MISSING_TENANT_ID' } }];\n}\n\nreturn [{\n  json: {\n    autenticado: true,\n    usuario: {\n      id: payload.sub ?? null,\n      email: payload.email ?? null,\n      tenant_id: payload.tenant_id,\n      role: payload.role ?? null,\n    },\n    token_payload: payload,\n  }\n}];\n"
      },
      "id": "336ae9f0-373b-4d18-86d2-433ae76b4795",
      "name": "Middleware Auth JWT",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        -128
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $items().length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "d9bdd2b2-a067-4ce3-bb06-166aac8064e7",
      "name": "Sessão Ativa?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        160,
        -128
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $('Middleware Auth JWT').item.json }}",
        "options": {}
      },
      "id": "d8cf6e7e-7667-428f-8ec0-d4edee0ee9e0",
      "name": "Response Auth Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        48,
        112
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "clientes",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "428e56b2-f2f8-4f3d-80c4-bace7631c121",
      "name": "Webhook Criar Cliente",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1280,
        -64
      ],
      "webhookId": "criar-cliente"
    },
    {
      "parameters": {
        "jsCode": "const body = $json.body ?? {};\nconst errors = [];\n\nconst nome = body.nome_completo ?? body.name ?? body.nome;\nif (!nome || typeof nome !== 'string' || nome.trim().length < 3) {\n  errors.push('nome_completo (ou name) é obrigatório e deve ter no mínimo 3 caracteres');\n}\n\n// CPF (se você realmente precisar, mantenha obrigatório)\nconst cpf = body.cpf;\nif (cpf) {\n  const cpfLimpo = String(cpf).replace(/\\D/g, '');\n  if (cpfLimpo.length !== 11) errors.push('cpf deve conter 11 dígitos');\n}\n// Se for obrigatório, troque por:\n// if (!cpf) errors.push('cpf é obrigatório');\n\nreturn [{\n  valido: errors.length === 0,\n  erro: errors.length ? 'Validação falhou' : null,\n  detalhes: errors,\n  input: body,\n}];\n"
      },
      "id": "357756ba-9d85-4e20-87d9-1d888815b6af",
      "name": "Validar Input Cliente",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1088,
        -64
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.valido }}",
              "value2": true
            }
          ]
        }
      },
      "id": "b5c87f0e-0c1f-42af-841d-c0a9dfbf5117",
      "name": "Input Cliente Válido?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -896,
        -64
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "fcc3fe6c-3e2b-4972-9d61-dc3110937f40",
      "name": "Response Validation Cliente Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -640,
        144
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "8a43426d-eef8-480b-a914-252ba0e4c166",
      "name": "Merge Auth Cliente",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        432,
        -32
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "64c001dc-7c42-4b17-9064-6d23d12b0051",
      "name": "Response Cliente Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1808,
        -32
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select table_schema, table_name\nfrom information_schema.tables\nwhere table_type = 'BASE TABLE'\n  and table_schema not in ('pg_catalog','information_schema')\n  and (\n    table_name ilike '%session%' OR\n    table_name ilike '%token%' OR\n    table_name ilike '%refresh%' OR\n    table_name ilike '%jwt%'\n  )\norder by table_schema, table_name;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -64,
        -128
      ],
      "id": "db831f7e-baa8-4df8-838a-580a439588a0",
      "name": "Execute a SQL query1",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "insert into public.clientes (\n  id,\n  tenant_id,\n  nome_completo,\n  cpf,\n  whatsapp,\n  email,\n  cep,\n  endereco,\n  complemento,\n  bairro,\n  cidade,\n  estado,\n  data_nascimento\n)\nvalues (\n  gen_random_uuid(),\n  NULLIF($1, '')::uuid,\n  $2,\n  $3,\n  $4,\n  $5,\n  $6,\n  $7,\n  $8,\n  $9,\n  $10,\n  $11,\n  $12\n)\non conflict (tenant_id, cpf)\ndo update set\n  nome_completo   = excluded.nome_completo,\n  whatsapp        = excluded.whatsapp,\n  email           = excluded.email,\n  cep             = excluded.cep,\n  endereco        = excluded.endereco,\n  complemento     = excluded.complemento,\n  bairro          = excluded.bairro,\n  cidade          = excluded.cidade,\n  estado          = excluded.estado,\n  data_nascimento = excluded.data_nascimento\nreturning *;\n",
        "options": {
          "queryReplacement": "={{ $json.tenant_id }}\n{{ $json.nome_completo }}\n{{ $json.cpf }}\n{{ $json.whatsapp }}\n{{ $json.email }}\n{{ $json.cep }}\n{{ $json.endereco }}\n{{ $json.complemento }}\n{{ $json.bairro }}\n{{ $json.cidade }}\n{{ $json.estado }}\n{{ $json.data_nascimento }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1552,
        -32
      ],
      "id": "95f190db-a9fc-4a0a-92a0-fabeaa37aade",
      "name": "Inserir Cliente Auth",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pega dados DIRETAMENTE do Webhook\nconst wh = $node[\"Webhook Criar Cliente\"].json;\n\n// Headers\nconst headers = wh.headers || {};\nconst auth =\n  headers.authorization ||\n  headers.Authorization ||\n  \"\";\n\n// Validação básica\nif (!auth.startsWith(\"Bearer \")) {\n  return [{\n    json: {\n      autenticado: false,\n      erro: \"NO_TOKEN\",\n      headers\n    }\n  }];\n}\n\n// Token JWT\nconst token = auth.replace(\"Bearer \", \"\").trim();\nconst parts = token.split(\".\");\n\n// JWT inválido\nif (parts.length !== 3) {\n  return [{\n    json: {\n      autenticado: false,\n      erro: \"INVALID_JWT_FORMAT\"\n    }\n  }];\n}\n\n// Decode payload (base64url)\nconst payloadB64 = parts[1]\n  .replace(/-/g, \"+\")\n  .replace(/_/g, \"/\");\n\nconst padded =\n  payloadB64 + \"=\".repeat((4 - payloadB64.length % 4) % 4);\n\nlet payload;\ntry {\n  payload = JSON.parse(\n    Buffer.from(padded, \"base64\").toString(\"utf8\")\n  );\n} catch (e) {\n  return [{\n    json: {\n      autenticado: false,\n      erro: \"INVALID_JWT_PAYLOAD\"\n    }\n  }];\n}\n\n// Tenant\nconst tenant_id =\n  payload.tenant_id ||\n  payload.tenantId ||\n  payload.tenant ||\n  null;\n\nif (!tenant_id) {\n  return [{\n    json: {\n      autenticado: false,\n      erro: \"TENANT_ID_NOT_FOUND\",\n      payload\n    }\n  }];\n}\n\n// SUCESSO\nreturn [{\n  json: {\n    autenticado: true,\n    usuario: {\n      id: payload.sub || null,\n      email: payload.email || null,\n      tenant_id,\n      role: payload.role || null\n    },\n    body: wh.body,\n    headers,\n    token,\n    payload\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -688,
        -160
      ],
      "id": "1154e4e7-c98b-4cea-a992-d75e5b8d29e4",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "7f74fa19-a1e0-4f9a-aedb-2347f9e1c088",
              "name": "tenant_debug",
              "value": "={{ $json.usuario?.tenant_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -272,
        -128
      ],
      "id": "0b217b1d-dcfe-40b0-ab9e-5f6ff1214c59",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "42798045-85e7-4901-bdb1-5924ccf42d42",
              "leftValue": "={{$json.autenticado}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "1fcbb5f3-3ea2-46da-90f9-e62a6437d74f",
              "leftValue": "={{$json.usuario.tenant_id}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        640,
        -32
      ],
      "id": "3ce1a1be-f386-418c-9569-4cbe12ef1035",
      "name": "If"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "289d35b6-acd5-4830-94a8-76f5c630ba38",
              "name": "tenant_id",
              "value": "={{ $('Middleware Auth JWT').first().json.usuario?.tenant_id || $json.usuario?.tenant_id || null }}\n",
              "type": "string"
            },
            {
              "id": "6d9e8f4f-db79-4ea4-b700-2bd437b6a68d",
              "name": "nome_completo",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.nome_completo }}",
              "type": "string"
            },
            {
              "id": "9aab13c7-110e-427e-817b-7c1b6d4ab981",
              "name": "cpf",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.cpf }}{{ String($json.cpf).replace(/\\D/g,'').trim() }}\n",
              "type": "string"
            },
            {
              "id": "249666c0-ce32-48d9-874e-03d4a236bf27",
              "name": "whatsapp",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.whatsapp }}",
              "type": "string"
            },
            {
              "id": "c5a33624-97b2-4b11-a30c-90351b9403e5",
              "name": "email",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.email }}",
              "type": "string"
            },
            {
              "id": "f5944949-8db8-4048-8f6d-2cd8b5eae9bd",
              "name": "cep",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.cep }}",
              "type": "string"
            },
            {
              "id": "5c3f242f-878d-4361-a1d3-a173f7f2c9ac",
              "name": "endereco",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.endereco }}",
              "type": "string"
            },
            {
              "id": "14a4fbbd-74c6-4ddc-9bce-9023c97c7507",
              "name": "complemento",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.complemento ?? null }}",
              "type": "string"
            },
            {
              "id": "4ae55017-098e-422b-8f8f-2153441087af",
              "name": "bairro",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.bairro }}",
              "type": "string"
            },
            {
              "id": "3942574b-ddea-4004-bfe2-95daa565690a",
              "name": "cidade",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.cidade }}",
              "type": "string"
            },
            {
              "id": "625c5b01-4fa8-4af7-aef0-8d4815331967",
              "name": "estado",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.estado }}",
              "type": "string"
            },
            {
              "id": "174bc781-c6ea-4400-bc28-ae5b86e8384e",
              "name": "data_nascimento",
              "value": "={{ $items(\"Webhook Criar Cliente\")[0].json.body.data_nascimento }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        848,
        64
      ],
      "id": "b8934365-894c-4c67-983c-c5356d6384d0",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "auth/login",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "4eb75352-d9ff-4803-bd7a-f1a8460925b0",
      "name": "Webhook Login",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1200,
        -912
      ],
      "webhookId": "auth-login"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// VALIDAÇÃO DE INPUT E RATE LIMITING\n// ============================================\n\nconst body = $json.body || {};\nconst headers = $json.headers || {};\nconst ip = headers['x-forwarded-for'] || headers['x-real-ip'] || 'unknown';\nconst userAgent = headers['user-agent'] || 'unknown';\n\n// Log estruturado\nconst logEntry = {\n  timestamp: new Date().toISOString(),\n  event: 'login_attempt',\n  ip: ip,\n  user_agent: userAgent,\n  email: body.email\n};\n\nconsole.log(JSON.stringify(logEntry));\n\n// Validação de entrada\nconst errors = [];\n\nif (!body.email || typeof body.email !== 'string') {\n  errors.push('Email é obrigatório e deve ser string');\n} else if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(body.email)) {\n  errors.push('Email inválido');\n}\n\nif (!body.senha || typeof body.senha !== 'string') {\n  errors.push('Senha é obrigatória e deve ser string');\n} else if (body.senha.length < 6) {\n  errors.push('Senha deve ter no mínimo 6 caracteres');\n}\n\nif (errors.length > 0) {\n  return {\n    json: {\n      erro: 'Validação falhou',\n      detalhes: errors,\n      valido: false\n    }\n  };\n}\n\n// Dados validados\nreturn {\n  json: {\n    email: body.email.toLowerCase().trim(),\n    senha: body.senha,\n    ip: ip,\n    user_agent: userAgent,\n    valido: true\n  }\n};"
      },
      "id": "b8e24cbf-1dcd-482d-8e64-8316c6dfacda",
      "name": "Validar Input Login",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1008,
        -912
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.valido }}",
              "value2": true
            }
          ]
        }
      },
      "id": "20fc353d-33c7-4b72-bd47-3860369352be",
      "name": "Input Válido?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -800,
        -912
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "tenant_users",
        "filters": {
          "conditions": [
            {
              "keyName": "email",
              "condition": "eq",
              "keyValue": "={{ $json.email }}"
            }
          ]
        }
      },
      "id": "fb2399b0-1dec-4d82-85ce-070ecb616f81",
      "name": "Buscar Usuário",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -608,
        -992
      ],
      "credentials": {
        "supabaseApi": {
          "id": "da98RlGr5W5pZnze",
          "name": "Supabase CredGestor"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "7fc44579-7df8-4fea-8e9c-86b448af44bc",
      "name": "Response Validation Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -544,
        -784
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $items().length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "a5dc61f4-58c0-4352-8836-1de4a3ca182a",
      "name": "Usuário Existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -400,
        -992
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "1c405265-0a99-4930-922a-d19954eb7194",
      "name": "Merge Dados Login",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        -208,
        -1072
      ]
    },
    {
      "parameters": {
        "jsCode": "//// ============================================\n//// VALIDAÇÃO DE SENHA COM BCRYPT\n//// ============================================\n//\n////const bcrypt = require('bcrypt');\n//\n////const inputData = $input.first().json;\n////const senhaDigitada = inputData.senha;\n////const ip = inputData.ip;\n//const userAgent = inputData.user_agent;\n//\n//const usuario = $input.last().json[0];\n//const senhaHash = usuario.senha_hash;\n//\n//// Verificar senha usando bcrypt\n//const senhaValida = await bcrypt.compare(senhaDigitada, senhaHash);\n//\n//if (!senhaValida) {\n//  // Log de falha\n//  console.log(JSON.stringify({\n//    timestamp: new Date().toISOString(),\n//    event: 'login_failed',\n//    email: usuario.email,\n//    ip: ip,\n//    reason: 'invalid_password'\n//  }));\n//  \n//  return {\n//    json: {\n//      autenticado: false,\n//      erro: 'Credenciais inválidas'\n//    }\n//  };\n//}\n//\n//// Log de sucesso\n//console.log(JSON.stringify({\n//  timestamp: new Date().toISOString(),\n//  event: 'login_success',\n//  user_id: usuario.id,\n//  tenant_id: usuario.tenant_id,\n//  ip: ip\n//}));\n//\n//return {\n//  json: {\n//    autenticado: true,\n//    usuario: {\n//      id: usuario.id,\n//      nome: usuario.nome,\n//      email: usuario.email,\n//      tenant_id: usuario.tenant_id,\n//      tenant_nome: usuario.tenant_nome,\n//      role: usuario.role\n//    },\n//    ip: ip,\n//    user_agent: userAgent\n//  }\n//};\n\n// LOGIN RESPONSE (1 Code node após SELECT)\n\nconst req = $items('Webhook Login')[0]?.json ?? $input.first().json;\n\nconst ip = req.ip ?? null;\nconst userAgent = req.user_agent ?? req.userAgent ?? null;\n\nconst users = $input.all().map(i => i.json);\nconst user = users[0]; // se o SELECT retornou, estará aqui\n\nif (!user || !user.id) {\n  console.log(JSON.stringify({\n    timestamp: new Date().toISOString(),\n    event: 'login_failed',\n    email: req.email ?? null,\n    ip,\n    user_agent: userAgent,\n    reason: 'invalid_credentials',\n  }));\n\n  return {\n    json: {\n      autenticado: false,\n      erro: 'Credenciais inválidas',\n      ip,\n      user_agent: userAgent,\n    },\n  };\n}\n\nconsole.log(JSON.stringify({\n  timestamp: new Date().toISOString(),\n  event: 'login_success',\n  user_id: user.id,\n  tenant_id: user.tenant_id,\n  email: user.email,\n  ip,\n  user_agent: userAgent,\n}));\n\nreturn {\n  json: {\n    autenticado: true,\n    usuario: {\n      id: user.id,\n      email: user.email,\n      tenant_id: user.tenant_id,\n      created_at: user.created_at,\n    },\n    ip,\n    user_agent: userAgent,\n  },\n};\n"
      },
      "id": "b0863d03-402d-4328-bec7-482a0f0487ca",
      "name": "Validar Senha",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        -1072
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.autenticado }}",
              "value2": true
            }
          ]
        }
      },
      "id": "56bdb9f7-e2b1-4ee3-aeea-99ed43cca310",
      "name": "Senha Válida?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        192,
        -1072
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ \n  JSON.stringify({\n    autenticado: true,\n    access_token: $node[\"Create Session\"].json.access_token || $node[\"Execute a SQL query\"].json.access_token || $node[\"Merge Dados Login\"].json.access_token,\n    refresh_token: $node[\"Create Session\"].json.refresh_token || $node[\"Execute a SQL query\"].json.refresh_token || $node[\"Merge Dados Login\"].json.refresh_token,\n    token_type: \"Bearer\",\n    expires_in: 900,\n    usuario: $node[\"Buscar Usuário\"].json || $node[\"Merge Dados Login\"].json.usuario || $json.usuario\n  }) \n}}\n",
        "options": {}
      },
      "id": "7382ead8-f5f0-4d70-8451-47252952a749",
      "name": "Response Login Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1440,
        -1104
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"erro\": \"Credenciais inválidas\" } }}",
        "options": {}
      },
      "id": "aced69fd-e09a-4477-aa19-f9bd03dbe7e2",
      "name": "Response Login Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -64,
        -800
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH u AS (\n  SELECT id, email, tenant_id\n  FROM public.tenant_users\n  WHERE id = '{{ $json.usuario.id }}'::uuid\n),\nids AS (\n  SELECT\n    gen_random_uuid()::text AS jti,\n    gen_random_uuid()::text AS refresh_jti\n),\ntokens AS (\n  SELECT\n    generate_jwt_hs256(\n      jsonb_build_object(\n        'sub', u.id,\n        'email', u.email,\n        'tenant_id', u.tenant_id,\n        'type', 'access',\n        'jti', ids.jti,\n        'iat', extract(epoch from now()),\n        'exp', extract(epoch from now() + interval '15 minutes')\n      ),\n      '{{ $env.JWT_SECRET }}'\n    ) AS access_token,\n\n    generate_jwt_hs256(\n      jsonb_build_object(\n        'sub', u.id,\n        'tenant_id', u.tenant_id,\n        'type', 'refresh',\n        'jti', ids.refresh_jti,\n        'iat', extract(epoch from now()),\n        'exp', extract(epoch from now() + interval '7 days')\n      ),\n      '{{ $env.JWT_REFRESH_SECRET }}'\n    ) AS refresh_token,\n\n    ids.jti,\n    ids.refresh_jti,\n    u.id AS user_id,\n    u.email,\n    u.tenant_id\n  FROM u, ids\n)\nSELECT\n  access_token,\n  refresh_token,\n  sha256_hex(refresh_token) AS refresh_token_hash,\n  'Bearer'::text AS token_type,\n  900::int AS expires_in,\n  (now() + interval '15 minutes') AS access_expires_at,\n  (now() + interval '7 days') AS refresh_expires_at,\n  jti,\n  refresh_jti,\n  user_id,\n  email,\n  tenant_id\nFROM tokens;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        368,
        -1088
      ],
      "id": "37c1a61f-b215-484f-9db1-e0468b6fa453",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.user_sessions (\n  user_id,\n  tenant_id,\n  refresh_token,\n  refresh_token_hash,\n  refresh_jti,\n  expires_at,\n  ip,\n  user_agent,\n  created_at\n)\nVALUES (\n  '{{ $json.user_id }}'::uuid,\n  '{{ $json.tenant_id }}'::uuid,\n  '{{ $json.refresh_token }}',\n  '{{ $json.refresh_token_hash }}',\n  '{{ $json.refresh_jti }}'::uuid,\n  '{{ $json.refresh_expires_at }}'::timestamptz,\n  NULLIF('{{ $json.ip }}','undefined'),\n  NULLIF('{{ $json.user_agent }}','undefined'),\n  now()\n)\nRETURNING id;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        528,
        -1088
      ],
      "id": "b435af21-7f86-449b-a4d4-a1e07557d8b3",
      "name": "Create Session",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.login_audit (\n  user_id, tenant_id, ip, user_agent, action, success, created_at\n)\nVALUES (\n  $1::uuid,\n  NULLIF($2, 'null')::uuid,\n  $3,\n  $4,\n  'login',\n  $5::boolean,\n  now()\n);\n",
        "options": {
          "queryReplacement": "={{ $json.user_id ?? $json.id }}\n\n{{ $json.tenant_id ?? null }}\n\n{{ $json.ip ?? null }}\n\n{{ $json.user_agent ?? null }}\n\n{{ true }}\n\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1232,
        -1104
      ],
      "id": "f6c8fcec-a241-4025-a8d7-b8a88f3bcf3b",
      "name": "Log Auditoria Login1",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "89adbf55-e4e6-4050-b71e-e82f519e2d71",
              "leftValue": "={{ $json.user_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1008,
        -1088
      ],
      "id": "12b3d1dc-b406-44c5-b489-f64c1e59b191",
      "name": "If1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6a92f942-3e52-4615-86c4-68d73bfea962",
              "name": "user_id",
              "value": "={{ $json.user_id ?? $json.id }}",
              "type": "string"
            },
            {
              "id": "188ac07d-09a2-403e-bd18-d33d96129397",
              "name": "tenant_id",
              "value": "={{ $json.tenant_id ?? $node[\"Merge Dados Login\"].json.tenant_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        752,
        -1088
      ],
      "id": "bcdc210e-fc67-47b0-b1ab-786aba2e7c23",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "content": "## Login Usuario\n**Double click** to edit me. [Guide](https://docs.n8n.io/workflows/sticky-notes/)",
        "height": 688,
        "width": 3184,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1408,
        -1216
      ],
      "id": "36db5866-b73c-4188-bef0-7d36e1185a5b",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Cadastrar Cliente\n**Double click** ",
        "height": 704,
        "width": 3440,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1424,
        -288
      ],
      "id": "2959d65e-d2a8-440d-a36f-9d7fc5c5341f",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6c12d3c1-439c-4554-94e9-9597a7bb6f17",
              "leftValue": "={{ $json.tenant_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1056,
        64
      ],
      "id": "22eada5a-9274-4e8f-98e1-517b385cb68e",
      "name": "If2"
    },
    {
      "parameters": {
        "jsCode": "// Gera um ID se não existir um válido\nif (!$json.id || String($json.id).length < 32) {\n    $json.id = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);\n        return v.toString(16);\n    });\n}\n\n// Limpa o CPF\nif ($json.cpf) {\n    $json.cpf = String($json.cpf).replace(/\\D/g, '').trim();\n}\n\nreturn $json;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1264,
        -32
      ],
      "id": "80ac82a6-b3f2-442b-bde1-569f2fad0051",
      "name": "Code gerador de UUID"
    }
  ],
  "pinData": {
    "Webhook Login": [
      {
        "json": {
          "headers": {
            "host": "n8n.aiagentautomate.com.br",
            "user-agent": "curl/7.81.0",
            "content-length": "61",
            "accept": "*/*",
            "content-type": "application/json",
            "x-forwarded-for": "200.39.37.99",
            "x-forwarded-host": "n8n.aiagentautomate.com.br",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "39017bc971e2",
            "x-real-ip": "200.39.37.99",
            "accept-encoding": "gzip"
          },
          "params": {},
          "query": {},
          "body": {
            "email": "aiagenteautomate@gmail.com",
            "senha": "061603F@tim@"
          },
          "webhookUrl": "https://n8n.aiagentautomate.com.br/webhook/auth/login",
          "executionMode": "production"
        }
      }
    ],
    "Webhook Criar Cliente": [
      {
        "json": {
          "headers": {
            "host": "n8n.aiagentautomate.com.br",
            "user-agent": "curl/7.81.0",
            "content-length": "315",
            "accept": "*/*",
            "authorization": "Bearer teste.teste.teste",
            "content-type": "application/json",
            "x-forwarded-for": "200.39.37.99",
            "x-forwarded-host": "n8n.aiagentautomate.com.br",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "39017bc971e2",
            "x-real-ip": "200.39.37.99",
            "accept-encoding": "gzip"
          },
          "params": {},
          "query": {},
          "body": {
            "nome_completo": "Jorge Oliveira",
            "cpf": "29891928293",
            "whatsapp": "11995231944",
            "email": "jolive@gmail.com",
            "cep": "05565010",
            "endereco": "Av Joaquim de Santana",
            "bairro": "Jardim Arpoador",
            "cidade": "São Paulo",
            "estado": "SP",
            "data_nascimento": "1990-05-10"
          },
          "webhookUrl": "https://n8n.aiagentautomate.com.br/webhook/clientes",
          "executionMode": "production"
        }
      }
    ]
  },
  "repo_name": "backup-n8n",
  "repo_owner": "faelsou",
  "repo_path": "backups",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-12-22T14:02:10.759Z",
      "updatedAt": "2025-12-22T14:02:10.759Z",
      "role": "workflow:owner",
      "workflowId": "roCzi3PseAtbr8r2",
      "projectId": "uxvBhUmI1Fx6jdU7"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 2,
  "updatedAt": "2025-12-29T15:18:39.720Z",
  "versionId": "ad7f4b16-72b9-46cb-b309-7ff382a62d3f"
}