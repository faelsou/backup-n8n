{
  "active": false,
  "connections": {
    "Webhook Login": {
      "main": [
        [
          {
            "node": "Validar Input Login",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Input Login": {
      "main": [
        [
          {
            "node": "Input Vﾃ｡lido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Vﾃ｡lido?": {
      "main": [
        [
          {
            "node": "Buscar Usuﾃ｡rio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Validation Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuﾃ｡rio": {
      "main": [
        [
          {
            "node": "Usuﾃ｡rio Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usuﾃ｡rio Existe?": {
      "main": [
        [
          {
            "node": "Merge Dados Login",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Response Login Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Dados Login": {
      "main": [
        [
          {
            "node": "Validar Senha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Senha": {
      "main": [
        [
          {
            "node": "Senha Vﾃ｡lida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Senha Vﾃ｡lida?": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Login Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar JWT Tokens": {
      "main": [
        []
      ]
    },
    "Criar Sessﾃ｣o": {
      "main": [
        []
      ]
    },
    "Log Auditoria Login": {
      "main": [
        []
      ]
    },
    "Middleware Auth JWT": {
      "main": [
        [
          {
            "node": "Execute a SQL query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Sessﾃ｣o Ativa": {
      "main": [
        []
      ]
    },
    "Sessﾃ｣o Ativa?": {
      "main": [
        [
          {
            "node": "Merge Auth Cliente",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Response Auth Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Criar Cliente": {
      "main": [
        [
          {
            "node": "Validar Input Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Input Cliente": {
      "main": [
        [
          {
            "node": "Input Cliente Vﾃ｡lido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Cliente Vﾃ｡lido?": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Response Validation Cliente Error",
            "type": "main",
            "index": 0
          },
          {
            "node": "Response Auth Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Auth Cliente": {
      "main": [
        []
      ]
    },
    "Merge Auth Cliente": {
      "main": [
        [
          {
            "node": "Inserir Cliente Auth",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Cliente": {
      "main": [
        []
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Create Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Session": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Auditoria Login1": {
      "main": [
        [
          {
            "node": "Response Login Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Log Auditoria Login1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query1": {
      "main": [
        [
          {
            "node": "Sessﾃ｣o Ativa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inserir Cliente Auth": {
      "main": [
        [
          {
            "node": "Response Cliente Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Middleware Auth JWT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-12-21T06:58:08.340Z",
  "id": "j5URj6bv0FMhKMcQ",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Backend Gestﾃ｣o Emprﾃｩstimos - Multi-tenant V2 (Secure)",
  "nodes": [
    {
      "parameters": {
        "content": "# 柏 AUTENTICAﾃﾃグ E SEGURANﾃ②\n\nImplementaﾃｧﾃｵes:\n- JWT com HS256\n- Refresh Tokens\n- Rate Limiting\n- Validaﾃｧﾃｵes de entrada\n- Auditoria completa",
        "height": 296,
        "width": 416,
        "color": 7
      },
      "id": "426d32fa-078e-476e-bc4b-dfad2df8e41c",
      "name": "Sticky Note Security",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -208,
        -80
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "auth/login",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "5e954861-ba0b-4f36-8244-94ee20f66e2c",
      "name": "Webhook Login",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        208,
        288
      ],
      "webhookId": "auth-login"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// VALIDAﾃﾃグ DE INPUT E RATE LIMITING\n// ============================================\n\nconst body = $json.body || {};\nconst headers = $json.headers || {};\nconst ip = headers['x-forwarded-for'] || headers['x-real-ip'] || 'unknown';\nconst userAgent = headers['user-agent'] || 'unknown';\n\n// Log estruturado\nconst logEntry = {\n  timestamp: new Date().toISOString(),\n  event: 'login_attempt',\n  ip: ip,\n  user_agent: userAgent,\n  email: body.email\n};\n\nconsole.log(JSON.stringify(logEntry));\n\n// Validaﾃｧﾃ｣o de entrada\nconst errors = [];\n\nif (!body.email || typeof body.email !== 'string') {\n  errors.push('Email ﾃｩ obrigatﾃｳrio e deve ser string');\n} else if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(body.email)) {\n  errors.push('Email invﾃ｡lido');\n}\n\nif (!body.senha || typeof body.senha !== 'string') {\n  errors.push('Senha ﾃｩ obrigatﾃｳria e deve ser string');\n} else if (body.senha.length < 6) {\n  errors.push('Senha deve ter no mﾃｭnimo 6 caracteres');\n}\n\nif (errors.length > 0) {\n  return {\n    json: {\n      erro: 'Validaﾃｧﾃ｣o falhou',\n      detalhes: errors,\n      valido: false\n    }\n  };\n}\n\n// Dados validados\nreturn {\n  json: {\n    email: body.email.toLowerCase().trim(),\n    senha: body.senha,\n    ip: ip,\n    user_agent: userAgent,\n    valido: true\n  }\n};"
      },
      "id": "7d9ce0cb-1c00-4681-a734-58efde1e44f4",
      "name": "Validar Input Login",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.valido }}",
              "value2": true
            }
          ]
        }
      },
      "id": "554b953f-b1f0-4d38-bd22-787ec63cc720",
      "name": "Input Vﾃ｡lido?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        608,
        288
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "tenant_users"
      },
      "id": "453ff2e3-8e32-4d99-834f-791803f5b567",
      "name": "Buscar Usuﾃ｡rio",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        800,
        208
      ],
      "credentials": {
        "supabaseApi": {
          "id": "da98RlGr5W5pZnze",
          "name": "Supabase CredGestor"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "2b01c043-d835-4692-84d2-43fc1765df55",
      "name": "Response Validation Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        864,
        416
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $items().length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "16de4458-4aee-462e-a173-b2130f62d353",
      "name": "Usuﾃ｡rio Existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1008,
        208
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "703f03c0-7cd4-44f1-af83-29a1c1e3c0c4",
      "name": "Merge Dados Login",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        1200,
        128
      ]
    },
    {
      "parameters": {
        "jsCode": "//// ============================================\n//// VALIDAﾃﾃグ DE SENHA COM BCRYPT\n//// ============================================\n//\n////const bcrypt = require('bcrypt');\n//\n////const inputData = $input.first().json;\n////const senhaDigitada = inputData.senha;\n////const ip = inputData.ip;\n//const userAgent = inputData.user_agent;\n//\n//const usuario = $input.last().json[0];\n//const senhaHash = usuario.senha_hash;\n//\n//// Verificar senha usando bcrypt\n//const senhaValida = await bcrypt.compare(senhaDigitada, senhaHash);\n//\n//if (!senhaValida) {\n//  // Log de falha\n//  console.log(JSON.stringify({\n//    timestamp: new Date().toISOString(),\n//    event: 'login_failed',\n//    email: usuario.email,\n//    ip: ip,\n//    reason: 'invalid_password'\n//  }));\n//  \n//  return {\n//    json: {\n//      autenticado: false,\n//      erro: 'Credenciais invﾃ｡lidas'\n//    }\n//  };\n//}\n//\n//// Log de sucesso\n//console.log(JSON.stringify({\n//  timestamp: new Date().toISOString(),\n//  event: 'login_success',\n//  user_id: usuario.id,\n//  tenant_id: usuario.tenant_id,\n//  ip: ip\n//}));\n//\n//return {\n//  json: {\n//    autenticado: true,\n//    usuario: {\n//      id: usuario.id,\n//      nome: usuario.nome,\n//      email: usuario.email,\n//      tenant_id: usuario.tenant_id,\n//      tenant_nome: usuario.tenant_nome,\n//      role: usuario.role\n//    },\n//    ip: ip,\n//    user_agent: userAgent\n//  }\n//};\n\n// LOGIN RESPONSE (1 Code node apﾃｳs SELECT)\n\nconst req = $items('Webhook Login')[0]?.json ?? $input.first().json;\n\nconst ip = req.ip ?? null;\nconst userAgent = req.user_agent ?? req.userAgent ?? null;\n\nconst users = $input.all().map(i => i.json);\nconst user = users[0]; // se o SELECT retornou, estarﾃ｡ aqui\n\nif (!user || !user.id) {\n  console.log(JSON.stringify({\n    timestamp: new Date().toISOString(),\n    event: 'login_failed',\n    email: req.email ?? null,\n    ip,\n    user_agent: userAgent,\n    reason: 'invalid_credentials',\n  }));\n\n  return {\n    json: {\n      autenticado: false,\n      erro: 'Credenciais invﾃ｡lidas',\n      ip,\n      user_agent: userAgent,\n    },\n  };\n}\n\nconsole.log(JSON.stringify({\n  timestamp: new Date().toISOString(),\n  event: 'login_success',\n  user_id: user.id,\n  tenant_id: user.tenant_id,\n  email: user.email,\n  ip,\n  user_agent: userAgent,\n}));\n\nreturn {\n  json: {\n    autenticado: true,\n    usuario: {\n      id: user.id,\n      email: user.email,\n      tenant_id: user.tenant_id,\n      created_at: user.created_at,\n    },\n    ip,\n    user_agent: userAgent,\n  },\n};\n"
      },
      "id": "759a5385-c587-449f-9416-768d0ec61947",
      "name": "Validar Senha",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1408,
        128
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.autenticado }}",
              "value2": true
            }
          ]
        }
      },
      "id": "c5a5124a-3f3f-4610-ae5a-6a6abcbeb908",
      "name": "Senha Vﾃ｡lida?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1600,
        128
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// JWT HS256 SEM LIBS (n8n Code Node) - WebCrypto\n// ============================================\n\nconst crypto = globalThis.crypto;\n\n// Helpers base64url\nfunction base64urlFromBytes(bytes) {\n  const b64 = Buffer.from(bytes).toString('base64');\n  return b64.replace(/=/g, '').replace(/\\+/g, '-').replace(/\\//g, '_');\n}\nfunction base64urlFromString(str) {\n  return base64urlFromBytes(Buffer.from(str, 'utf8'));\n}\nfunction jsonToBase64url(obj) {\n  return base64urlFromString(JSON.stringify(obj));\n}\n\n// WebCrypto helpers\nasync function hmacSignHS256(secret, data) {\n  const enc = new TextEncoder();\n  const key = await crypto.subtle.importKey(\n    'raw',\n    enc.encode(secret),\n    { name: 'HMAC', hash: 'SHA-256' },\n    false,\n    ['sign']\n  );\n  const sig = await crypto.subtle.sign('HMAC', key, enc.encode(data));\n  return base64urlFromBytes(new Uint8Array(sig));\n}\n\nasync function sha256Hex(str) {\n  const enc = new TextEncoder();\n  const digest = await crypto.subtle.digest('SHA-256', enc.encode(str));\n  return Buffer.from(new Uint8Array(digest)).toString('hex');\n}\n\n// 笨 RANDOM COMPATﾃ昂EL COM N8N\nasync function randomHex(bytes = 16) {\n  const enc = new TextEncoder();\n  const seed = `${Date.now()}-${Math.random()}-${Math.random()}`;\n  const digest = await crypto.subtle.digest('SHA-256', enc.encode(seed));\n  const hex = Buffer.from(new Uint8Array(digest)).toString('hex');\n  return hex.slice(0, bytes * 2);\n}\n\nfunction unixNow() {\n  return Math.floor(Date.now() / 1000);\n}\n\nasync function signJwtHS256(payload, secret, { issuer, audience, expiresInSeconds, jwtid }) {\n  const header = { alg: 'HS256', typ: 'JWT' };\n\n  const now = unixNow();\n  const fullPayload = {\n    ...payload,\n    iss: issuer,\n    aud: audience,\n    iat: now,\n    exp: now + expiresInSeconds,\n    ...(jwtid ? { jti: jwtid } : {}),\n  };\n\n  const headerB64 = jsonToBase64url(header);\n  const payloadB64 = jsonToBase64url(fullPayload);\n  const signingInput = `${headerB64}.${payloadB64}`;\n  const signatureB64 = await hmacSignHS256(secret, signingInput);\n\n  return `${signingInput}.${signatureB64}`;\n}\n\n// =====================\n// INPUT\n// =====================\n\nconst JWT_SECRET = $env.JWT_SECRET;\nconst JWT_REFRESH_SECRET = $env.JWT_REFRESH_SECRET;\n\nif (!JWT_SECRET || !JWT_REFRESH_SECRET) {\n  throw new Error('JWT_SECRET ou JWT_REFRESH_SECRET nﾃ｣o configurados.');\n}\n\nconst JWT_ISSUER = 'credgestor-api';\nconst JWT_AUDIENCE = 'credgestor-app';\n\nconst usuario = $json.usuario;\nif (!usuario?.id || !usuario?.tenant_id) {\n  throw new Error('usuario.id e usuario.tenant_id sﾃ｣o obrigatﾃｳrios.');\n}\n\nconst ip = $json.ip ?? null;\nconst userAgent = $json.user_agent ?? null;\n\n// IDs\nconst jti = await randomHex(16);\nconst refreshJti = await randomHex(16);\n\n// Expiraﾃｧﾃ｣o\nconst ACCESS_EXPIRES_SECONDS = 15 * 60;\nconst REFRESH_EXPIRES_SECONDS = 7 * 24 * 60 * 60;\n\n// Payloads\nconst accessPayload = {\n  sub: usuario.id,\n  email: usuario.email,\n  tenant_id: usuario.tenant_id,\n  role: usuario.role ?? 'user',\n  type: 'access',\n};\n\nconst refreshPayload = {\n  sub: usuario.id,\n  tenant_id: usuario.tenant_id,\n  type: 'refresh',\n  jti: refreshJti,\n};\n\n// Tokens\nconst accessToken = await signJwtHS256(accessPayload, JWT_SECRET, {\n  issuer: JWT_ISSUER,\n  audience: JWT_AUDIENCE,\n  expiresInSeconds: ACCESS_EXPIRES_SECONDS,\n  jwtid: jti,\n});\n\nconst refreshToken = await signJwtHS256(refreshPayload, JWT_REFRESH_SECRET, {\n  issuer: JWT_ISSUER,\n  audience: JWT_AUDIENCE,\n  expiresInSeconds: REFRESH_EXPIRES_SECONDS,\n  jwtid: refreshJti,\n});\n\n// Hash refresh\nconst refreshTokenHash = await sha256Hex(refreshToken);\n\n// Datas\nconst nowMs = Date.now();\n\nreturn {\n  json: {\n    access_token: accessToken,\n    refresh_token: refreshToken,\n    refresh_token_hash: refreshTokenHash,\n    token_type: 'Bearer',\n    expires_in: ACCESS_EXPIRES_SECONDS,\n    access_expires_at: new Date(nowMs + ACCESS_EXPIRES_SECONDS * 1000).toISOString(),\n    refresh_expires_at: new Date(nowMs + REFRESH_EXPIRES_SECONDS * 1000).toISOString(),\n    jti,\n    refresh_jti: refreshJti,\n    usuario,\n    ip,\n    user_agent: userAgent,\n  },\n};\n"
      },
      "id": "bdb74700-083d-4cc8-9485-a5cfc87af918",
      "name": "Gerar JWT Tokens",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1744,
        -128
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "tenant_users"
      },
      "id": "fa885323-71c4-449e-aeda-0743647fd048",
      "name": "Criar Sessﾃ｣o",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2064,
        -128
      ],
      "credentials": {
        "supabaseApi": {
          "id": "da98RlGr5W5pZnze",
          "name": "Supabase CredGestor"
        }
      }
    },
    {
      "parameters": {
        "tableId": "tenant_users"
      },
      "id": "ce39373f-0094-4859-a186-a511753a8267",
      "name": "Log Auditoria Login",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2352,
        -96
      ],
      "credentials": {
        "supabaseApi": {
          "id": "da98RlGr5W5pZnze",
          "name": "Supabase CredGestor"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  \"autenticado\": true,\n  \"access_token\": $json.access_token,\n  \"refresh_token\": $json.refresh_token,\n  \"token_type\": \"Bearer\",\n  \"expires_in\": 900,\n  \"usuario\": $json.usuario\n}) }}\n",
        "options": {}
      },
      "id": "2a66c486-926a-4e8e-a611-8f3e688e3788",
      "name": "Response Login Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2848,
        112
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"erro\": \"Credenciais invﾃ｡lidas\" } }}",
        "options": {}
      },
      "id": "65632c83-6290-4dad-bb74-6965717173e5",
      "name": "Response Login Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1344,
        400
      ]
    },
    {
      "parameters": {
        "content": "# 泊 MIDDLEWARE DE AUTENTICAﾃﾃグ JWT\n\nFunﾃｧﾃ｣o centralizada para:\n- Validar JWT\n- Verificar tenant_id\n- Checar permissﾃｵes\n- Logs estruturados",
        "height": 328,
        "width": 384,
        "color": 6
      },
      "id": "fe775e2b-9443-4eca-b52a-a0a9a8afd92a",
      "name": "Sticky Note Middleware",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -240,
        448
      ]
    },
    {
      "parameters": {
        "jsCode": "function base64UrlDecode(str) {\n  return JSON.parse(Buffer.from(str.replace(/-/g, '+').replace(/_/g, '/'), 'base64').toString());\n}\n\nconst headers = $json.headers || {};\nconst authHeader = headers.authorization || headers.Authorization || '';\n\nif (!authHeader.startsWith('Bearer ')) {\n  return [{ json: { autenticado: false, erro: 'NO_TOKEN' } }];\n}\n\nconst token = authHeader.slice(7);\nconst parts = token.split('.');\n\nif (parts.length !== 3) {\n  return [{ json: { autenticado: false, erro: 'INVALID_TOKEN_FORMAT' } }];\n}\n\nconst payload = base64UrlDecode(parts[1]);\n\n// Validaﾃｧﾃｵes\nif (payload.exp * 1000 < Date.now()) {\n  return [{ json: { autenticado: false, erro: 'TOKEN_EXPIRED' } }];\n}\n\nif (payload.iss !== 'credgestor-api') {\n  return [{ json: { autenticado: false, erro: 'INVALID_ISSUER' } }];\n}\n\nreturn [{\n  json: {\n    autenticado: true,\n    usuario: {\n      id: payload.sub,\n      email: payload.email,\n      tenant_id: payload.tenant_id,\n      role: payload.role\n    }\n  }\n}];\n"
      },
      "id": "71fcbcd4-7359-4748-8b49-d5abfe444220",
      "name": "Middleware Auth JWT",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1136,
        640
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery"
      },
      "id": "c55328ae-9424-4b15-b319-2ce8aeb14e38",
      "name": "Verificar Sessﾃ｣o Ativa",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        1744,
        1248
      ],
      "credentials": {
        "supabaseApi": {
          "id": "da98RlGr5W5pZnze",
          "name": "Supabase CredGestor"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $items().length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "86782142-89ff-45d4-b5c9-b3f84735fec2",
      "name": "Sessﾃ｣o Ativa?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1568,
        640
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $('Middleware Auth JWT').item.json }}",
        "options": {}
      },
      "id": "185940d9-2be5-41b1-afd1-201ec073d290",
      "name": "Response Auth Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1456,
        880
      ]
    },
    {
      "parameters": {
        "content": "# 則 GESTﾃグ DE CLIENTES\n\nEndpoints:\n- POST /clientes\n- GET /clientes/:tenant_id\n- PUT /clientes/:id\n- DELETE /clientes/:id",
        "height": 264,
        "width": 400,
        "color": 5
      },
      "id": "104f5bd7-1a6a-409b-bde5-86ddeb6ffd72",
      "name": "Sticky Note Clientes",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -256,
        800
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "clientes",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "7f90c712-f189-46cf-8fee-2062e64f4dad",
      "name": "Webhook Criar Cliente",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        336,
        704
      ],
      "webhookId": "criar-cliente"
    },
    {
      "parameters": {
        "jsCode": "const body = $json.body ?? {};\nconst errors = [];\n\nconst nome = body.nome_completo ?? body.name ?? body.nome;\nif (!nome || typeof nome !== 'string' || nome.trim().length < 3) {\n  errors.push('nome_completo (ou name) ﾃｩ obrigatﾃｳrio e deve ter no mﾃｭnimo 3 caracteres');\n}\n\n// CPF (se vocﾃｪ realmente precisar, mantenha obrigatﾃｳrio)\nconst cpf = body.cpf;\nif (cpf) {\n  const cpfLimpo = String(cpf).replace(/\\D/g, '');\n  if (cpfLimpo.length !== 11) errors.push('cpf deve conter 11 dﾃｭgitos');\n}\n// Se for obrigatﾃｳrio, troque por:\n// if (!cpf) errors.push('cpf ﾃｩ obrigatﾃｳrio');\n\nreturn [{\n  valido: errors.length === 0,\n  erro: errors.length ? 'Validaﾃｧﾃ｣o falhou' : null,\n  detalhes: errors,\n  input: body,\n}];\n"
      },
      "id": "a9167a80-fc0f-4196-85e6-918139d96b4a",
      "name": "Validar Input Cliente",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        704
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.valido }}",
              "value2": true
            }
          ]
        }
      },
      "id": "9c655b18-ffc7-4e9f-b7c0-2d966a128f9c",
      "name": "Input Cliente Vﾃ｡lido?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        720,
        704
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "72e66f50-e06e-476c-a802-4ad82301cc40",
      "name": "Response Validation Cliente Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        976,
        912
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "98687b11-0627-4b8b-833f-b628114cab4a",
      "name": "Preparar Auth Cliente",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.2,
      "position": [
        480,
        432
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "012786c5-19d9-4512-850a-a3bd49eda05a",
      "name": "Merge Auth Cliente",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [
        1840,
        736
      ]
    },
    {
      "parameters": {
        "tableId": "clientes"
      },
      "id": "9d918ec9-b4b3-4517-89ac-a91b63c39b64",
      "name": "Criar Cliente",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        2112,
        1216
      ],
      "credentials": {
        "supabaseApi": {
          "id": "da98RlGr5W5pZnze",
          "name": "Supabase CredGestor"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {}
      },
      "id": "ebcd4e19-2e10-418d-a5d2-7253227ebeed",
      "name": "Response Cliente Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2384,
        736
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH u AS (\n  SELECT id, email, tenant_id\n  FROM public.tenant_users\n  WHERE id = '{{ $json.usuario.id }}'::uuid\n),\nids AS (\n  SELECT\n    gen_random_uuid()::text AS jti,\n    gen_random_uuid()::text AS refresh_jti\n),\ntokens AS (\n  SELECT\n    generate_jwt_hs256(\n      jsonb_build_object(\n        'sub', u.id,\n        'email', u.email,\n        'tenant_id', u.tenant_id,\n        'type', 'access',\n        'jti', ids.jti,\n        'iat', extract(epoch from now()),\n        'exp', extract(epoch from now() + interval '15 minutes')\n      ),\n      '{{ $env.JWT_SECRET }}'\n    ) AS access_token,\n\n    generate_jwt_hs256(\n      jsonb_build_object(\n        'sub', u.id,\n        'tenant_id', u.tenant_id,\n        'type', 'refresh',\n        'jti', ids.refresh_jti,\n        'iat', extract(epoch from now()),\n        'exp', extract(epoch from now() + interval '7 days')\n      ),\n      '{{ $env.JWT_REFRESH_SECRET }}'\n    ) AS refresh_token,\n\n    ids.jti,\n    ids.refresh_jti,\n    u.id AS user_id,\n    u.email,\n    u.tenant_id\n  FROM u, ids\n)\nSELECT\n  access_token,\n  refresh_token,\n  sha256_hex(refresh_token) AS refresh_token_hash,\n  'Bearer'::text AS token_type,\n  900::int AS expires_in,\n  (now() + interval '15 minutes') AS access_expires_at,\n  (now() + interval '7 days') AS refresh_expires_at,\n  jti,\n  refresh_jti,\n  user_id,\n  email,\n  tenant_id\nFROM tokens;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1760,
        64
      ],
      "id": "6560600a-1a0c-44b5-81a4-de98436f1fa7",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.user_sessions (\n  user_id,\n  tenant_id,\n  refresh_token,\n  refresh_token_hash,\n  refresh_jti,\n  expires_at,\n  ip,\n  user_agent,\n  created_at\n)\nVALUES (\n  '{{ $json.user_id }}'::uuid,\n  '{{ $json.tenant_id }}'::uuid,\n  '{{ $json.refresh_token }}',\n  '{{ $json.refresh_token_hash }}',\n  '{{ $json.refresh_jti }}'::uuid,\n  '{{ $json.refresh_expires_at }}'::timestamptz,\n  NULLIF('{{ $json.ip }}','undefined'),\n  NULLIF('{{ $json.user_agent }}','undefined'),\n  now()\n)\nRETURNING id;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1936,
        96
      ],
      "id": "29cc80e5-0e01-496e-8a89-a9e9cfb8de99",
      "name": "Create Session",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.login_audit (\n  user_id, tenant_id, ip, user_agent, action, success, created_at\n)\nVALUES (\n  $1::uuid,\n  NULLIF($2, 'null')::uuid,\n  $3,\n  $4,\n  'login',\n  $5::boolean,\n  now()\n);\n",
        "options": {
          "queryReplacement": "={{ $json.user_id ?? $json.id }}\n\n{{ $json.tenant_id ?? null }}\n\n{{ $json.ip ?? null }}\n\n{{ $json.user_agent ?? null }}\n\n{{ true }}\n\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2640,
        96
      ],
      "id": "479fce43-2c19-4d55-8802-aaac7651e097",
      "name": "Log Auditoria Login1",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "89adbf55-e4e6-4050-b71e-e82f519e2d71",
              "leftValue": "={{ $json.user_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2416,
        112
      ],
      "id": "93f45f85-9386-44ef-8c59-a5b3efde3251",
      "name": "If"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6a92f942-3e52-4615-86c4-68d73bfea962",
              "name": "user_id",
              "value": "={{ $json.user_id ?? $json.id }}",
              "type": "string"
            },
            {
              "id": "188ac07d-09a2-403e-bd18-d33d96129397",
              "name": "tenant_id",
              "value": "={{ $json.tenant_id ?? $node[\"Merge Dados Login\"].json.tenant_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2160,
        112
      ],
      "id": "c332f594-64d0-4a1d-b032-7fb16f3fe7b2",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "select table_schema, table_name\nfrom information_schema.tables\nwhere table_type = 'BASE TABLE'\n  and table_schema not in ('pg_catalog','information_schema')\n  and (\n    table_name ilike '%session%' OR\n    table_name ilike '%token%' OR\n    table_name ilike '%refresh%' OR\n    table_name ilike '%jwt%'\n  )\norder by table_schema, table_name;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1344,
        640
      ],
      "id": "8ac9ccaf-72cf-4e9f-9ce1-8dde9bde1d38",
      "name": "Execute a SQL query1",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "insert into public.clientes (\n  tenant_id,\n  nome_completo,\n  cpf,\n  whatsapp,\n  email,\n  cep,\n  endereco,\n  complemento,\n  bairro,\n  cidade,\n  estado,\n  data_nascimento\n)\nvalues (\n  '{{ $json.tenant_id }}'::uuid,\n  '{{ $json.nome_completo }}',\n  '{{ $json.cpf }}',\n  {{ $json.whatsapp === null ? 'NULL' : \"'\" + $json.whatsapp + \"'\" }},\n  {{ $json.email === null ? 'NULL' : \"'\" + $json.email + \"'\" }},\n  {{ $json.cep === null ? 'NULL' : \"'\" + $json.cep + \"'\" }},\n  {{ $json.endereco === null ? 'NULL' : \"'\" + $json.endereco + \"'\" }},\n  {{ $json.complemento === null ? 'NULL' : \"'\" + $json.complemento + \"'\" }},\n  {{ $json.bairro === null ? 'NULL' : \"'\" + $json.bairro + \"'\" }},\n  {{ $json.cidade === null ? 'NULL' : \"'\" + $json.cidade + \"'\" }},\n  {{ $json.estado === null ? 'NULL' : \"'\" + $json.estado + \"'\" }},\n  {{ $json.data_nascimento === null ? 'NULL' : \"'\" + $json.data_nascimento + \"'\" }}\n)\nreturning *;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2048,
        736
      ],
      "id": "1dc8be47-f4a0-4cc1-9673-10569a6d822f",
      "name": "Inserir Cliente Auth",
      "credentials": {
        "postgres": {
          "id": "ISeq8ovLtFz7Vb1t",
          "name": "Postgres CredGestor"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Pega dados DIRETAMENTE do Webhook\nconst wh = $node[\"Webhook Criar Cliente\"].json;\n\n// Headers\nconst headers = wh.headers || {};\nconst auth =\n  headers.authorization ||\n  headers.Authorization ||\n  \"\";\n\n// Validaﾃｧﾃ｣o bﾃ｡sica\nif (!auth.startsWith(\"Bearer \")) {\n  return [{\n    json: {\n      autenticado: false,\n      erro: \"NO_TOKEN\",\n      headers\n    }\n  }];\n}\n\n// Token JWT\nconst token = auth.replace(\"Bearer \", \"\").trim();\nconst parts = token.split(\".\");\n\n// JWT invﾃ｡lido\nif (parts.length !== 3) {\n  return [{\n    json: {\n      autenticado: false,\n      erro: \"INVALID_JWT_FORMAT\"\n    }\n  }];\n}\n\n// Decode payload (base64url)\nconst payloadB64 = parts[1]\n  .replace(/-/g, \"+\")\n  .replace(/_/g, \"/\");\n\nconst padded =\n  payloadB64 + \"=\".repeat((4 - payloadB64.length % 4) % 4);\n\nlet payload;\ntry {\n  payload = JSON.parse(\n    Buffer.from(padded, \"base64\").toString(\"utf8\")\n  );\n} catch (e) {\n  return [{\n    json: {\n      autenticado: false,\n      erro: \"INVALID_JWT_PAYLOAD\"\n    }\n  }];\n}\n\n// Tenant\nconst tenant_id =\n  payload.tenant_id ||\n  payload.tenantId ||\n  payload.tenant ||\n  null;\n\nif (!tenant_id) {\n  return [{\n    json: {\n      autenticado: false,\n      erro: \"TENANT_ID_NOT_FOUND\",\n      payload\n    }\n  }];\n}\n\n// SUCESSO\nreturn [{\n  json: {\n    autenticado: true,\n    usuario: {\n      id: payload.sub || null,\n      email: payload.email || null,\n      tenant_id,\n      role: payload.role || null\n    },\n    body: wh.body,\n    headers,\n    token,\n    payload\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        928,
        608
      ],
      "id": "b05fd4b9-9006-41b0-a7a1-0bf398fcd03b",
      "name": "Code in JavaScript"
    }
  ],
  "pinData": {
    "Webhook Login": [
      {
        "json": {
          "headers": {
            "host": "n8n.aiagentautomate.com.br",
            "user-agent": "curl/7.81.0",
            "content-length": "61",
            "accept": "*/*",
            "content-type": "application/json",
            "x-forwarded-for": "200.39.37.99",
            "x-forwarded-host": "n8n.aiagentautomate.com.br",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "39017bc971e2",
            "x-real-ip": "200.39.37.99",
            "accept-encoding": "gzip"
          },
          "params": {},
          "query": {},
          "body": {
            "email": "aiagenteautomate@gmail.com",
            "senha": "061603F@tim@"
          },
          "webhookUrl": "https://n8n.aiagentautomate.com.br/webhook/auth/login",
          "executionMode": "production"
        }
      }
    ]
  },
  "repo_name": "backup-n8n",
  "repo_owner": "faelsou",
  "repo_path": "backups",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-12-21T06:58:08.340Z",
      "updatedAt": "2025-12-21T06:58:08.340Z",
      "role": "workflow:owner",
      "workflowId": "j5URj6bv0FMhKMcQ",
      "projectId": "uxvBhUmI1Fx6jdU7"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 2,
  "updatedAt": "2025-12-23T06:04:19.463Z",
  "versionId": "612c86de-7a53-4bd4-9577-1f92365be900"
}