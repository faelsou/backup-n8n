{
  "active": false,
  "connections": {
    "Verificar Novos Usu√°rios": {
      "main": [
        [
          {
            "node": "Buscar Novos Usu√°rios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Novos Usu√°rios": {
      "main": [
        [
          {
            "node": "Processar Dados do Usu√°rio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Dados do Usu√°rio": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dividir em Lotes": {
      "main": [
        []
      ]
    },
    "Registrar Envio no Log": {
      "main": [
        [
          {
            "node": "Registrar Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Erros": {
      "main": [
        [
          {
            "node": "Registrar Erro",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registrar Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a message": {
      "main": [
        [
          {
            "node": "Registrar Envio no Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-17T03:17:46.962Z",
  "id": "MwwrpqfwCWwEpeom",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Onboarding - Novo Usu√°rio CredGestor",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/5 * * * *"
            }
          ]
        }
      },
      "id": "2eb39afd-083b-49d0-aec2-46fcc97ea2a5",
      "name": "Verificar Novos Usu√°rios",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -1536,
        112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT\n  tu.id,\n  tu.email,\n  tu.tenant_id,\n  tu.role,\n  tu.created_at,\n  t.name  AS tenant_name,\n  t.slug  AS tenant_slug,\n\n  -- Idade do registro (quanto tempo atr√°s foi criado)\n  (now() - tu.created_at) AS idade,\n\n  -- Marca se √© \"novo\" dentro de 24h\n  (tu.created_at >= now() - interval '24 hours') AS is_novo_24h,\n\n  -- Classifica√ß√£o por janela (a menor janela que ele se encaixa)\n  CASE\n    WHEN tu.created_at >= now() - interval '5 minutes'  THEN '05_MIN'\n    WHEN tu.created_at >= now() - interval '15 minutes' THEN '15_MIN'\n    WHEN tu.created_at >= now() - interval '30 minutes' THEN '30_MIN'\n    WHEN tu.created_at >= now() - interval '1 hour'     THEN '01_H'\n    WHEN tu.created_at >= now() - interval '2 hours'    THEN '02_H'\n    WHEN tu.created_at >= now() - interval '3 hours'    THEN '03_H'\n    WHEN tu.created_at >= now() - interval '6 hours'    THEN '06_H'\n    WHEN tu.created_at >= now() - interval '12 hours'   THEN '12_H'\n    WHEN tu.created_at >= now() - interval '24 hours'   THEN '24_H'\n    ELSE 'OLD'\n  END AS janela_novo\n\nFROM public.tenant_users tu\nLEFT JOIN public.tenants t ON t.id = tu.tenant_id\nWHERE tu.ativo = true\nORDER BY tu.created_at DESC;\n",
        "options": {}
      },
      "id": "d0676a47-d20e-4055-a1ce-2335312b9c7d",
      "name": "Buscar Novos Usu√°rios",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1328,
        112
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "5W8bQyCCsNE27usm",
          "name": "Postgres CredGestor-Homologa√ß√£o"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Processar dados do novo usu√°rio e preparar email de onboarding\nconst items = $input.all();\nconst processedItems = [];\n\nfor (const item of items) {\n  const usuario = item.json;\n  \n  // Verificar se o email √© v√°lido\n  if (!usuario.email || !usuario.email.includes('@')) {\n    continue;\n  }\n  \n  // Formatar data de cria√ß√£o\n  const dataCriacao = new Date(usuario.created_at);\n  const dataFormatada = dataCriacao.toLocaleDateString('pt-BR', {\n    day: '2-digit',\n    month: '2-digit',\n    year: 'numeric',\n    hour: '2-digit',\n    minute: '2-digit'\n  });\n  \n  // Nome do tenant ou padr√£o\n  const tenantName = usuario.tenant_name || 'CredGestor';\n  \n  // Extrair nome do email (parte antes do @)\n  const nomeUsuario = usuario.email.split('@')[0].split('.').map(\n    palavra => palavra.charAt(0).toUpperCase() + palavra.slice(1)\n  ).join(' ');\n  \n  // Montar conte√∫do do email HTML\n  const emailHtml = `\n<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Bem-vindo ao CredGestor</title>\n  <style>\n    body {\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n      line-height: 1.6;\n      color: #333;\n      max-width: 600px;\n      margin: 0 auto;\n      padding: 20px;\n      background-color: #f5f5f5;\n    }\n    .container {\n      background-color: #ffffff;\n      border-radius: 8px;\n      padding: 30px;\n      box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n    }\n    .header {\n      text-align: center;\n      margin-bottom: 30px;\n    }\n    .logo {\n      background-color: #10b981;\n      color: white;\n      width: 60px;\n      height: 60px;\n      border-radius: 12px;\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      font-size: 24px;\n      font-weight: bold;\n      margin-bottom: 15px;\n    }\n    h1 {\n      color: #1f2937;\n      margin: 0;\n      font-size: 24px;\n    }\n    .content {\n      color: #4b5563;\n      margin-bottom: 30px;\n    }\n    .button {\n      display: inline-block;\n      background-color: #10b981;\n      color: white;\n      padding: 12px 30px;\n      text-decoration: none;\n      border-radius: 6px;\n      font-weight: 600;\n      text-align: center;\n      margin: 20px 0;\n    }\n    .button:hover {\n      background-color: #059669;\n    }\n    .features {\n      background-color: #f9fafb;\n      border-radius: 6px;\n      padding: 20px;\n      margin: 20px 0;\n    }\n    .feature-item {\n      margin: 10px 0;\n      padding-left: 25px;\n      position: relative;\n    }\n    .feature-item:before {\n      content: '‚úì';\n      position: absolute;\n      left: 0;\n      color: #10b981;\n      font-weight: bold;\n    }\n    .footer {\n      text-align: center;\n      color: #6b7280;\n      font-size: 14px;\n      margin-top: 30px;\n      padding-top: 20px;\n      border-top: 1px solid #e5e7eb;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"logo\">CG</div>\n      <h1>Bem-vindo ao CredGestor!</h1>\n    </div>\n    \n    <div class=\"content\">\n      <p>Ol√° <strong>${nomeUsuario}</strong>,</p>\n      \n      <p>√â um prazer ter voc√™ conosco! Sua conta foi criada com sucesso em <strong>${tenantName}</strong>.</p>\n      \n      <p>O CredGestor √© a solu√ß√£o completa para gerenciar seus empr√©stimos e parcelas de forma simples e eficiente.</p>\n      \n      <div class=\"features\">\n        <h3 style=\"margin-top: 0; color: #1f2937;\">O que voc√™ pode fazer:</h3>\n        <div class=\"feature-item\">Cadastrar e gerenciar seus clientes</div>\n        <div class=\"feature-item\">Criar e acompanhar empr√©stimos</div>\n        <div class=\"feature-item\">Controlar parcelas e recebimentos</div>\n        <div class=\"feature-item\">Enviar cobran√ßas via WhatsApp</div>\n        <div class=\"feature-item\">Visualizar relat√≥rios e dashboards</div>\n        <div class=\"feature-item\">Acessar de qualquer dispositivo</div>\n      </div>\n      \n      <div style=\"text-align: center;\">\n        <a href=\"https://credgestor.app.br\" class=\"button\">Acessar Minha Conta</a>\n      </div>\n      \n      <p style=\"margin-top: 30px;\">Se voc√™ tiver alguma d√∫vida ou precisar de ajuda, nossa equipe de suporte est√° sempre dispon√≠vel.</p>\n      \n      <p>Bem-vindo e aproveite a plataforma!</p>\n      \n      <p>Equipe CredGestor</p>\n    </div>\n    \n    <div class=\"footer\">\n      <p>Este √© um email autom√°tico de boas-vindas. Por favor, n√£o responda este email.</p>\n      <p>CredGestor - Sistema de Gest√£o de Cr√©dito</p>\n      <p>Conta criada em: ${dataFormatada}</p>\n    </div>\n  </div>\n</body>\n</html>\n  `;\n  \n  // Vers√£o texto simples (fallback)\n  const emailTexto = `\nBem-vindo ao CredGestor!\n\nOl√° ${nomeUsuario},\n\n√â um prazer ter voc√™ conosco! Sua conta foi criada com sucesso em ${tenantName}.\n\nO CredGestor √© a solu√ß√£o completa para gerenciar seus empr√©stimos e parcelas de forma simples e eficiente.\n\nO que voc√™ pode fazer:\n‚úì Cadastrar e gerenciar seus clientes\n‚úì Criar e acompanhar empr√©stimos\n‚úì Controlar parcelas e recebimentos\n‚úì Enviar cobran√ßas via WhatsApp\n‚úì Visualizar relat√≥rios e dashboards\n‚úì Acessar de qualquer dispositivo\n\nAcesse sua conta: https://credgestor.app.br\n\nSe voc√™ tiver alguma d√∫vida ou precisar de ajuda, nossa equipe de suporte est√° sempre dispon√≠vel.\n\nBem-vindo e aproveite a plataforma!\n\nEquipe CredGestor\n\n---\nEste √© um email autom√°tico de boas-vindas.\nCredGestor - Sistema de Gest√£o de Cr√©dito\nConta criada em: ${dataFormatada}\n  `;\n  \n  processedItems.push({\n    json: {\n      usuario_id: usuario.id,\n      email: usuario.email,\n      nome_usuario: nomeUsuario,\n      tenant_id: usuario.tenant_id,\n      tenant_name: tenantName,\n      tenant_slug: usuario.tenant_slug,\n      role: usuario.role,\n      data_criacao: usuario.created_at,\n      data_formatada: dataFormatada,\n      email_html: emailHtml,\n      email_texto: emailTexto,\n      assunto: `Bem-vindo ao CredGestor, ${nomeUsuario}!`\n    }\n  });\n}\n\nreturn processedItems;"
      },
      "id": "7e247db1-45d6-4162-aa98-4e72d58e7080",
      "name": "Processar Dados do Usu√°rio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1104,
        112
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "64dca01d-1b80-4323-9bce-2c8bb933f651",
      "name": "Dividir em Lotes",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -944,
        -240
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO public.login_audit (\n  tenant_id,\n  user_id,\n  email,\n  success,\n  metadata\n) VALUES (\n  '{{ $json.tenant_id }}'::uuid,\n  '{{ $json.usuario_id }}'::uuid,\n  '{{ $json.email }}',\n  true,\n  '{\"action\": \"onboarding_email_sent\", \"sent_at\": \"' || NOW() || '\"}'::jsonb\n)\nON CONFLICT DO NOTHING;",
        "options": {}
      },
      "id": "6da28a5e-3084-43b0-a853-bbf48e1cd4ff",
      "name": "Registrar Envio no Log",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -448,
        112
      ],
      "credentials": {
        "postgres": {
          "id": "5W8bQyCCsNE27usm",
          "name": "Postgres CredGestor-Homologa√ß√£o"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "error-condition",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4dcda3a2-d444-4254-ae29-b44d44572702",
      "name": "Verificar Erros",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -224,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "// Log de erro para debug\nconst error = $input.first().json.error || 'Erro desconhecido';\nconst usuario = $input.first().json;\n\nconsole.error('Erro ao enviar email de onboarding:', {\n  usuario_id: usuario.usuario_id,\n  email: usuario.email,\n  erro: error\n});\n\nreturn [{\n  json: {\n    sucesso: false,\n    usuario_id: usuario.usuario_id,\n    email: usuario.email,\n    erro: error,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "46db93c1-7998-4a12-b72e-99f6dd57e1d2",
      "name": "Registrar Erro",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        208
      ]
    },
    {
      "parameters": {
        "jsCode": "// Log de sucesso\nconst usuario = $input.first().json;\n\nconsole.log('Email de onboarding enviado com sucesso:', {\n  usuario_id: usuario.usuario_id,\n  email: usuario.email,\n  tenant: usuario.tenant_name\n});\n\nreturn [{\n  json: {\n    sucesso: true,\n    usuario_id: usuario.usuario_id,\n  email: usuario.email,\n    tenant_name: usuario.tenant_name,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "4d459e59-489c-4cd2-a18c-6d9dedd6684a",
      "name": "Registrar Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "sendTo": "=cred.gestor1@gmail.com",
        "subject": "üéâ Bem-vindo √† CredGestor! Vamos come√ßar üöÄ",
        "emailType": "text",
        "message": "=Ol√°, {{ $json.nome_usuario }}!  Seja muito bem-vindo(a) √† CredGestor! üëã Estamos muito felizes por voc√™ ter escolhido nossa plataforma para facilitar a gest√£o dos seus empr√©stimos e opera√ß√µes de cr√©dito.  A CredGestor foi criada para oferecer controle inteligente, simplicidade no uso e visibilidade total dos seus dados financeiros ‚Äî tudo isso em um √∫nico lugar, de forma r√°pida e segura.  üîë O que voc√™ pode fazer com a CredGestor  Aqui est√£o algumas das principais funcionalidades que voc√™ j√° pode come√ßar a usar:  üìä Dashboard intuitivo com vis√£o completa das suas opera√ß√µes;  üìë Controle e organiza√ß√£o de empr√©stimos por cliente, status e data;  üìà Relat√≥rios autom√°ticos para decis√µes mais r√°pidas;  üîî Notifica√ß√µes e lembretes para acompanhar prazos relevantes;  ü§ù Integra√ß√£o simples com seus processos internos.  Tudo isso pensado para que voc√™ ganhe tempo e controle na sua rotina financeira desde o primeiro acesso.",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -672,
        16
      ],
      "id": "2669672a-c409-4266-a240-261d852a9bf1",
      "name": "Send a message",
      "webhookId": "8a274f35-0fc2-4a9b-b925-eaaeb901827a",
      "credentials": {
        "gmailOAuth2": {
          "id": "a6p3Q2T0CPdmQVBb",
          "name": "Gmail account 3"
        }
      }
    }
  ],
  "pinData": {},
  "repo_name": "backup-n8n",
  "repo_owner": "faelsou",
  "repo_path": "backups",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2026-01-17T03:17:46.962Z",
      "updatedAt": "2026-01-17T03:17:46.962Z",
      "role": "workflow:owner",
      "workflowId": "MwwrpqfwCWwEpeom",
      "projectId": "uxvBhUmI1Fx6jdU7"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-17T04:00:00.141Z",
  "versionId": "9b2c45f7-ab69-4663-8bba-3d77a0e90749"
}