{
  "active": false,
  "connections": {
    "Agendamento Diário": {
      "main": [
        [
          {
            "node": "Buscar Parcelas Vencendo Hoje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Parcelas Vencendo Hoje": {
      "main": [
        [
          {
            "node": "Processar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Dados": {
      "main": [
        [
          {
            "node": "Dividir em Lotes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dividir em Lotes": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "Verificar Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Sucesso": {
      "main": [
        [
          {
            "node": "Atualizar Parcela",
            "type": "main",
            "index": 0
          },
          {
            "node": "Registrar Log Sucesso",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registrar Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Parcela": {
      "main": [
        [
          {
            "node": "Resumo Execução",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Log Sucesso": {
      "main": [
        [
          {
            "node": "Resumo Execução",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Erro": {
      "main": [
        [
          {
            "node": "Resumo Execução",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-12T08:41:14.480Z",
  "id": "bCFw5QUdWuHZJUYm",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Cobrança Automática - Vencimento Hoje",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 8 * * *"
            }
          ]
        }
      },
      "id": "c0cd8f3d-abe5-40e8-ad4b-ffc7bc16e266",
      "name": "Agendamento Diário",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -1328,
        112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=SELECT \n  par.id as parcela_id,\n  par.numero_parcela,\n  par.valor_parcela,\n  par.data_vencimento,\n  par.status,\n  c.id as cliente_id,\n  c.nome as cliente_nome,\n  c.whatsapp,\n  c.celular,\n  c.telefone,\n  prop.numero_proposta,\n  prop.valor_aprovado\nFROM public.parcelas par\nJOIN public.propostas prop ON par.proposta_id = prop.id\nJOIN public.clients c ON prop.cliente_id = c.id\nWHERE par.data_vencimento = CURRENT_DATE\n  AND par.status IN ('pendente', 'atrasado')\n  AND c.ativo = true\n  AND (c.whatsapp IS NOT NULL OR c.celular IS NOT NULL OR c.telefone IS NOT NULL)\nORDER BY par.data_vencimento, c.nome;",
        "options": {}
      },
      "id": "0b6a330f-16c5-4943-bcda-fd00c084831f",
      "name": "Buscar Parcelas Vencendo Hoje",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1104,
        112
      ],
      "credentials": {
        "postgres": {
          "id": "5W8bQyCCsNE27usm",
          "name": "Postgres CredGestor-Homologação"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Processar cada parcela e preparar dados para envio\nconst items = $input.all();\nconst processedItems = [];\n\nfor (const item of items) {\n  const parcela = item.json;\n  \n  // Determinar o telefone a usar (prioridade: whatsapp > celular > telefone)\n  let telefone = parcela.whatsapp || parcela.celular || parcela.telefone;\n  \n  // Remover caracteres não numéricos\n  telefone = telefone ? telefone.replace(/\\D/g, '') : null;\n  \n  // Se não começar com 55 (código do Brasil), adicionar\n  if (telefone && !telefone.startsWith('55')) {\n    telefone = '55' + telefone;\n  }\n  \n  // Formatar valor da parcela\n  const valorFormatado = new Intl.NumberFormat('pt-BR', {\n    style: 'currency',\n    currency: 'BRL'\n  }).format(parseFloat(parcela.valor_parcela || 0));\n  \n  // Formatar data de vencimento\n  const dataVenc = new Date(parcela.data_vencimento);\n  const dataFormatada = dataVenc.toLocaleDateString('pt-BR');\n  \n  // Montar mensagem\n  const mensagem = `Olá ${parcela.cliente_nome}!\\n\\n` +\n    `Lembrete: Sua parcela ${parcela.numero_parcela} no valor de ${valorFormatado} ` +\n    `vence hoje (${dataFormatada}).\\n\\n` +\n    `Por favor, realize o pagamento para evitar juros e multa.\\n\\n` +\n    `Proposta: ${parcela.numero_proposta}\\n` +\n    `Obrigado!`;\n  \n  if (telefone) {\n    processedItems.push({\n      json: {\n        parcela_id: parcela.parcela_id,\n        cliente_id: parcela.cliente_id,\n        cliente_nome: parcela.cliente_nome,\n        telefone: telefone,\n        mensagem: mensagem,\n        valor_parcela: parcela.valor_parcela,\n        numero_parcela: parcela.numero_parcela,\n        data_vencimento: parcela.data_vencimento,\n        numero_proposta: parcela.numero_proposta\n      }\n    });\n  }\n}\n\nreturn processedItems;"
      },
      "id": "71c27233-fb39-49e3-8935-981b19790547",
      "name": "Processar Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        112
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "fa75bf23-223d-4127-a926-211769234aca",
      "name": "Dividir em Lotes",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -656,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.WHATSAPP_API_URL || 'https://api.whatsapp.com/send' }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "=Bearer {{ $env.WHATSAPP_API_TOKEN }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $json.telefone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.mensagem }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ca366d1d-1b23-46af-b52a-9a895a7e8468",
      "name": "Enviar WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -448,
        112
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "Vg1sLZdXLdtpj9vh",
          "name": "Header Auth account"
        }
      },
      "notes": "Configure a URL da API de WhatsApp e o token nas variáveis de ambiente do n8n.\n\nExemplos de APIs compatíveis:\n- Evolution API\n- Twilio WhatsApp\n- WhatsApp Business API\n- ChatAPI\n\nOu use um webhook customizado."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-1",
              "leftValue": "={{ $json.statusCode }}",
              "rightValue": 200,
              "operator": {
                "type": "number",
                "operation": "largerEqual",
                "singleValue": true
              }
            },
            {
              "id": "condition-2",
              "leftValue": "={{ $json.statusCode }}",
              "rightValue": 299,
              "operator": {
                "type": "number",
                "operation": "smallerEqual",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "32598d45-2ed3-4e63-99a4-ecb0cf000455",
      "name": "Verificar Sucesso",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -224,
        112
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=UPDATE public.parcelas\nSET updated_at = CURRENT_TIMESTAMP\nWHERE id = '{{ $(''Processar Dados'').item.json.parcela_id }}';",
        "options": {}
      },
      "id": "84394890-8281-4178-872a-15f69fb93153",
      "name": "Atualizar Parcela",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        0,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "5W8bQyCCsNE27usm",
          "name": "Postgres CredGestor-Homologação"
        }
      }
    },
    {
      "parameters": {
        "schema": "public",
        "table": "login_audit",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tenant_id": "={{ $(''Buscar Parcelas Vencendo Hoje'').item.json.tenant_id || ''00000000-0000-0000-0000-000000000001'' }}",
            "user_id": "={{ $(''Processar Dados'').item.json.cliente_id }}",
            "email": "cobranca_automatica@system",
            "success": true,
            "created_at": "={{ $now }}"
          }
        },
        "options": {}
      },
      "id": "307f8f91-d118-49b3-88f7-9466a689556e",
      "name": "Registrar Log Sucesso",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        0,
        208
      ],
      "credentials": {
        "postgres": {
          "id": "5W8bQyCCsNE27usm",
          "name": "Postgres CredGestor-Homologação"
        }
      },
      "notes": "Opcional: Registrar envio bem-sucedido no log de auditoria"
    },
    {
      "parameters": {
        "jsCode": "// Log de erro\nconst error = $input.first().json;\n\nreturn [{\n  json: {\n    erro: true,\n    mensagem: `Falha ao enviar mensagem para ${$('Processar Dados').item.json.cliente_nome}`,\n    telefone: $('Processar Dados').item.json.telefone,\n    statusCode: error.statusCode || 'N/A',\n    erro_detalhes: error.error || error.message || 'Erro desconhecido',\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "3d3bc38b-b880-4f4b-acf1-934b4c4c12e6",
      "name": "Registrar Erro",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -48,
        368
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "summary-1",
              "name": "total_processadas",
              "value": "={{ $('Dividir em Lotes').item.json.totalItems || 0 }}",
              "type": "number"
            },
            {
              "id": "summary-2",
              "name": "total_enviadas",
              "value": "={{ $('Verificar Sucesso').all().filter(item => item.json.statusCode >= 200 && item.json.statusCode <= 299).length }}",
              "type": "number"
            },
            {
              "id": "summary-3",
              "name": "total_erros",
              "value": "={{ $('Registrar Erro').all().length }}",
              "type": "number"
            },
            {
              "id": "summary-4",
              "name": "data_execucao",
              "value": "={{ $now }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "28b4f76f-c64f-4e89-98e6-69b0d199e284",
      "name": "Resumo Execução",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        224,
        112
      ]
    }
  ],
  "pinData": {},
  "repo_name": "backup-n8n",
  "repo_owner": "faelsou",
  "repo_path": "backups",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2026-01-12T08:41:14.480Z",
      "updatedAt": "2026-01-12T08:41:14.480Z",
      "role": "workflow:owner",
      "workflowId": "bCFw5QUdWuHZJUYm",
      "projectId": "uxvBhUmI1Fx6jdU7"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-01-12T09:16:38.309Z",
  "versionId": "2f34a3fa-00e9-4dba-b918-649a2e8be5f1"
}