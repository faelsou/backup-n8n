{
  "active": false,
  "connections": {
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Formatar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Dados": {
      "main": [
        [
          {
            "node": "Buscar Sess√£o Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Sess√£o Redis": {
      "main": [
        [
          {
            "node": "Assistente Sofia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Assistente Sofia",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memory Buffer": {
      "ai_memory": [
        [
          {
            "node": "Assistente Sofia",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "buscar_horarios_disponiveis": {
      "ai_tool": [
        [
          {
            "node": "Assistente Sofia",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "agendar_aula_espanhol": {
      "ai_tool": [
        [
          {
            "node": "Assistente Sofia",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Assistente Sofia": {
      "main": [
        [
          {
            "node": "Enviar Resposta WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Resposta WhatsApp": {
      "main": [
        [
          {
            "node": "Salvar Sess√£o Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-18T10:32:53.067Z",
  "id": "Q5fpINzdE2VUGT9X",
  "isArchived": false,
  "meta": null,
  "name": "My workflow 28",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "messages"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -500,
        1060
      ],
      "id": "4dc05e4a-65aa-4921-8e29-62d87cc4a8bc",
      "name": "WhatsApp Trigger",
      "webhookId": "escola-espanhol-trigger"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "session-id",
              "name": "sessionId",
              "value": "={{$json[\"messages\"][0][\"from\"]}}",
              "type": "string"
            },
            {
              "id": "message-text",
              "name": "messageText",
              "value": "={{$json[\"messages\"][0][\"text\"][\"body\"]}}",
              "type": "string"
            },
            {
              "id": "phone-number",
              "name": "phoneNumber",
              "value": "={{$json[\"messages\"][0][\"from\"].replace('@s.whatsapp.net', '')}}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -300,
        1060
      ],
      "id": "dee69239-dc88-40a7-8902-7a95798fc0d0",
      "name": "Formatar Dados"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "={{$json.sessionId}}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -100,
        1060
      ],
      "id": "cb4425cc-282c-4e8d-b3a6-9252b111e854",
      "name": "Buscar Sess√£o Redis"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        100,
        1260
      ],
      "id": "5dba80af-38fe-49e9-a4c3-0b54e34f3fd7",
      "name": "OpenAI Chat Model"
    },
    {
      "parameters": {
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        240,
        1260
      ],
      "id": "a274bd63-8cd9-4009-b784-c9b465bfd9cf",
      "name": "Memory Buffer"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Use esta ferramenta para buscar hor√°rios dispon√≠veis na agenda. Busque sempre por data espec√≠fica no formato YYYY-MM-DD.",
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "escola.espanhol@gmail.com",
          "mode": "list",
          "cachedResultName": "escola.espanhol@gmail.com"
        },
        "returnAll": true,
        "options": {
          "timeMin": "={{ $fromAI('data_inicio') }}T00:00:00Z",
          "timeMax": "={{ $fromAI('data_fim') }}T23:59:59Z"
        }
      },
      "id": "699f2a04-cda4-49ce-a68e-7e9d34e44db4",
      "name": "buscar_horarios_disponiveis",
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.2,
      "position": [
        380,
        1360
      ]
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Use esta ferramenta para agendar aulas de espanhol. Sempre confirme hor√°rio dispon√≠vel antes de agendar.",
        "calendar": {
          "__rl": true,
          "value": "escola.espanhol@gmail.com",
          "mode": "list",
          "cachedResultName": "escola.espanhol@gmail.com"
        },
        "start": "={{ $fromAI('data_hora_inicio') }}",
        "end": "={{ $fromAI('data_hora_fim') }}",
        "additionalFields": {
          "attendees": [
            "={{ $fromAI('email_aluno') }}"
          ],
          "color": "2",
          "conferenceDataUi": {
            "conferenceDataValues": {
              "conferenceSolution": "hangoutsMeet"
            }
          },
          "description": "Aula de Espanhol - {{ $fromAI('nivel') }}\nAluno: {{ $fromAI('nome_aluno') }}\nTelefone: {{ $fromAI('telefone') }}",
          "sendUpdates": "all",
          "summary": "Aula de Espanhol - {{ $fromAI('nome_aluno') }} ({{ $fromAI('nivel') }})"
        }
      },
      "id": "85aa594e-eebc-4d8c-acbc-eebda7bec636",
      "name": "agendar_aula_espanhol",
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.2,
      "position": [
        560,
        1420
      ]
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 1,
      "position": [
        340,
        1600
      ],
      "id": "02095b0d-bb68-4da1-a33c-18f7be8b9513",
      "name": "salvar_dados_aluno",
      "credentials": {}
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 1,
      "position": [
        580,
        1660
      ],
      "id": "987046e3-e463-4b39-affe-aef3b5ef7ccd",
      "name": "buscar_link_grupo",
      "credentials": {}
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Formatar Dados').item.json.messageText }}",
        "options": {
          "systemMessage": "=<systemData>\nData de hoje: {{ $now.weekdayLong }}, {{ $now.format('dd/MM/yyyy') }}, {{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0') }}\n</systemData>\n\n**Nome da Assistente**: Sofia\n**Especialidade**: Coordenadora de Matr√≠culas - Escola de Espanhol ¬°Habla Ya!\n**Personalidade**: Amig√°vel, paciente e entusiasmada com o ensino de espanhol\n\n<Agent>\n  <Name>Sofia</Name>\n  <Description>Coordenadora de Matr√≠culas da Escola de Espanhol ¬°Habla Ya!</Description>\n  <Language>Portugu√™s Brasileiro</Language>\n\n  <Greeting>\n    ¬°Hola! üëã Sou a Sofia, coordenadora da Escola de Espanhol ¬°Habla Ya! \n    Que alegria ter voc√™ aqui! Como posso te ajudar hoje? \n    ‚Ä¢ Agendar uma aula experimental gratuita? üìö\n    ‚Ä¢ Conhecer nossos cursos? \n    ‚Ä¢ Tirar d√∫vidas sobre o espanhol? üá™üá∏\n  </Greeting>\n</Agent>\n\n<CourseInfo>\n  <Levels>\n    ‚Ä¢ **Iniciante**: Para quem est√° come√ßando do zero\n    ‚Ä¢ **B√°sico**: J√° conhece o b√°sico e quer evoluir\n    ‚Ä¢ **Intermedi√°rio**: Consegue se comunicar mas quer flu√™ncia\n    ‚Ä¢ **Avan√ßado**: Busca aperfei√ßoamento e conversa√ß√£o\n    ‚Ä¢ **Conversa√ß√£o**: Foco em di√°logos e express√£o oral\n  </Levels>\n  \n  <Schedule>\n    ‚Ä¢ Segunda a Sexta: 8h √†s 20h\n    ‚Ä¢ S√°bado: 8h √†s 16h\n    ‚Ä¢ Aulas de 1h cada\n    ‚Ä¢ Grupos pequenos (m√°x 6 alunos)\n  </Schedule>\n</CourseInfo>\n\n<Process>\n  1. **Sauda√ß√£o e Identifica√ß√£o do Interesse**\n  2. **Coleta de Dados**: Nome, email, telefone, n√≠vel de espanhol\n  3. **Agendamento**: Verificar disponibilidade e agendar aula experimental\n  4. **Confirma√ß√£o**: Salvar dados e enviar confirma√ß√£o\n  5. **Grupo WhatsApp**: Enviar link do grupo do n√≠vel correspondente\n</Process>\n\n<Rules>\n  ‚Ä¢ Sempre seja calorosa e entusiasmada\n  ‚Ä¢ Colete TODOS os dados antes de agendar: nome completo, email, telefone, n√≠vel\n  ‚Ä¢ Verifique disponibilidade antes de confirmar hor√°rio\n  ‚Ä¢ Ap√≥s agendamento, SEMPRE envie o link do grupo do WhatsApp\n  ‚Ä¢ Encoraje o aluno sobre a jornada no espanhol\n  ‚Ä¢ Use express√µes em espanhol ocasionalmente para criar conex√£o\n</Rules>\n\n<DataCollection>\n  Para agendar, preciso de:\n  ‚Ä¢ Nome completo\n  ‚Ä¢ Email\n  ‚Ä¢ Telefone (WhatsApp)\n  ‚Ä¢ Qual seu n√≠vel atual de espanhol?\n  ‚Ä¢ Melhor dia/hor√°rio para sua aula experimental\n</DataCollection>\n\n<GroupLinks>\n  Ap√≥s agendamento confirmado, enviar:\n  \"¬°Perfecto! Seu agendamento est√° confirmado! üéâ\n  \n  Agora vou te adicionar ao nosso grupo do WhatsApp do n√≠vel [N√çVEL]. L√° voc√™ vai:\n  ‚Ä¢ Conhecer outros alunos üë•\n  ‚Ä¢ Receber dicas di√°rias de espanhol üì±\n  ‚Ä¢ Praticar com exerc√≠cios r√°pidos ‚úçÔ∏è\n  ‚Ä¢ Ficar por dentro das novidades da escola üì¢\n  \n  ¬°Nos vemos pronto! üá™üá∏\"\n</GroupLinks>"
        }
      },
      "id": "64907083-8f8b-4726-83f5-e51b3e854757",
      "name": "Assistente Sofia",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.6,
      "position": [
        280,
        1060
      ]
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "escola-espanhol",
        "remoteJid": "={{ $('Formatar Dados').item.json.sessionId }}",
        "messageText": "={{ $json.output }}",
        "options_message": {}
      },
      "id": "c129d0b7-f33e-40b2-bc2a-995e48ccbd3d",
      "name": "Enviar Resposta WhatsApp",
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [
        780,
        1060
      ]
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{$('Formatar Dados').item.json.sessionId}}",
        "value": "={{JSON.stringify({conversation: $json.output, timestamp: $now.toISOString()})}}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1100,
        1060
      ],
      "id": "8202825e-5f79-4f1a-b936-2fca17e9ed54",
      "name": "Salvar Sess√£o Redis"
    },
    {
      "parameters": {
        "content": "# Escola de Espanhol ¬°Habla Ya!",
        "height": 80,
        "width": 400,
        "color": 5
      },
      "id": "0392918b-1e04-4d0a-b3c3-48a80d7d5f8c",
      "name": "T√≠tulo",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -900,
        940
      ]
    },
    {
      "parameters": {
        "content": "## Fluxo Principal:\n1. WhatsApp Trigger\n2. Formatar dados da mensagem\n3. Buscar sess√£o no Redis\n4. Assistente Sofia (IA)\n5. Ferramentas dispon√≠veis:\n   - Buscar hor√°rios\n   - Agendar aulas\n   - Salvar aluno\n   - Buscar grupo WhatsApp\n6. Responder no WhatsApp\n7. Salvar sess√£o no Redis",
        "height": 200,
        "width": 400,
        "color": 6
      },
      "id": "a67cc94d-35b8-4baa-967c-36ec5181d7d7",
      "name": "Fluxo",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -180,
        1440
      ]
    }
  ],
  "pinData": {},
  "repo_name": "backup-n8n",
  "repo_owner": "faelsou",
  "repo_path": "backups",
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-06-18T10:32:53.067Z",
      "updatedAt": "2025-06-18T10:32:53.067Z",
      "role": "workflow:owner",
      "workflowId": "Q5fpINzdE2VUGT9X",
      "projectId": "uxvBhUmI1Fx6jdU7"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-06-18T10:32:53.067Z",
  "versionId": "6e38c8c0-d911-4b75-9814-342807700382"
}